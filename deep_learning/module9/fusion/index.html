
<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Mathieu Klimczak">
      
      
      
        <link rel="prev" href="../Module9_TFTRT/">
      
      
        <link rel="next" href="../bnn/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.2">
    
    
      
        <title>Annexe, RepVGG - Arctic Vault</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.f56500e0.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CJetBrains+Mono+Medium:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"JetBrains Mono Medium"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../../stylesheets/mkdocsoad.css">
    
      <link rel="stylesheet" href="../../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#fusion-conv-bn-et-repvgg" class="md-skip">
          Aller au contenu
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="En-tÃªte">
    <a href="../../.." title="Arctic Vault" class="md-header__button md-logo" aria-label="Arctic Vault" data-md-component="logo">
      
  <img src="../../../images/noun_Robot_1955251.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Arctic Vault
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Annexe, RepVGG
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Basculer en mode sombre"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Basculer en mode sombre" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="deep-orange"  aria-label="Basculer en mode clair"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Basculer en mode clair" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Rechercher" placeholder="Rechercher" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Effacer" aria-label="Effacer" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initialisation de la recherche
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Onglets" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Accueil
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../module1/Module1/" class="md-tabs__link md-tabs__link--active">
        Deep Learning
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../mlops/docker/" class="md-tabs__link">
        MLOps
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../azure_ml/intro/" class="md-tabs__link">
        AzureML
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../devops/linux/" class="md-tabs__link">
        DevOps 101
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../az104/az-ad/" class="md-tabs__link">
        AZ-104
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../ide_vscode/conf/" class="md-tabs__link">
        Guidelines
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../lectures/gradient_centralization/" class="md-tabs__link">
        Lectures
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Arctic Vault" class="md-nav__button md-logo" aria-label="Arctic Vault" data-md-component="logo">
      
  <img src="../../../images/noun_Robot_1955251.svg" alt="logo">

    </a>
    Arctic Vault
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Accueil
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Deep Learning
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Deep Learning" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Deep Learning
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          Introduction au deep learning, prise en main de Tensorflow et Keras
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Introduction au deep learning, prise en main de Tensorflow et Keras" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Introduction au deep learning, prise en main de Tensorflow et Keras
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module1/Module1/" class="md-nav__link">
        ThÃ©orie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module1/tp1/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          Les rÃ©seaux de neurones convolutifs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Les rÃ©seaux de neurones convolutifs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Les rÃ©seaux de neurones convolutifs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module2/Module2/" class="md-nav__link">
        ThÃ©orie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module2/module2_annexe/" class="md-nav__link">
        Annexe
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module2/tp2/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          Preprocessing des donnÃ©es avec l'API tf.data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Preprocessing des donnÃ©es avec l'API tf.data" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Preprocessing des donnÃ©es avec l'API tf.data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module3/Module3/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_4">
          Optimisation et rÃ©gularisation des rÃ©seaux de neurones
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Optimisation et rÃ©gularisation des rÃ©seaux de neurones" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Optimisation et rÃ©gularisation des rÃ©seaux de neurones
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module4/Module4/" class="md-nav__link">
        ThÃ©orie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module4/Module4_2/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_5">
          Personnaliser son rÃ©seau de neurones
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Personnaliser son rÃ©seau de neurones" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          Personnaliser son rÃ©seau de neurones
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module5/Module5/" class="md-nav__link">
        ThÃ©orie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module5/Module5_2/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" type="checkbox" id="__nav_2_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_6">
          La segmentation d'images
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="La segmentation d'images" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          La segmentation d'images
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module6/module6/" class="md-nav__link">
        ThÃ©orie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module6/Module6_2/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7" type="checkbox" id="__nav_2_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_7">
          Les modÃ¨les gÃ©nÃ©rateurs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Les modÃ¨les gÃ©nÃ©rateurs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          Les modÃ¨les gÃ©nÃ©rateurs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module7/Module7_2/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_8" type="checkbox" id="__nav_2_8" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_8">
          DÃ©ployer son rÃ©seau de neurones sur de l'embarquÃ©
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="DÃ©ployer son rÃ©seau de neurones sur de l'embarquÃ©" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_8">
          <span class="md-nav__icon md-icon"></span>
          DÃ©ployer son rÃ©seau de neurones sur de l'embarquÃ©
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../module9/" class="md-nav__link">
        ThÃ©orie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tp9_elaguage/" class="md-nav__link">
        Pratique, l'Ã©lagage
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tp9_tflite/" class="md-nav__link">
        Pratique, TFLite
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Module9_TFTRT/" class="md-nav__link">
        Pratique, TFTRT
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Annexe, RepVGG
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Annexe, RepVGG
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table des matiÃ¨res">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matiÃ¨res
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#etude-des-poids-des-conv-3-times-3-et-des-batchnorm" class="md-nav__link">
    Etude des poids des Conv \(3 \times 3\) et des BatchNorm
  </a>
  
    <nav class="md-nav" aria-label="Etude des poids des Conv \(3 \times 3\) et des BatchNorm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initialisation-dun-modele" class="md-nav__link">
    Initialisation d'un modÃ¨le
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etude-de-la-couche-convolutive" class="md-nav__link">
    Etude de la couche convolutive
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etude-de-la-batchnorm" class="md-nav__link">
    Etude de la batchnorm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fusion-dune-convolution-et-dune-batchnorm" class="md-nav__link">
    Fusion d'une Convolution et d'une batchnorm
  </a>
  
    <nav class="md-nav" aria-label="Fusion d'une Convolution et d'une batchnorm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nouveau-tenseur-de-poids" class="md-nav__link">
    Nouveau tenseur de poids
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nouveau-tenseur-de-biais" class="md-nav__link">
    Nouveau tenseur de biais
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verification-via-les-developpements-limites" class="md-nav__link">
    VÃ©rification via les dÃ©veloppements limitÃ©s
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#repvgg" class="md-nav__link">
    RepVGG
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fusion-dune-conv-3times3-avec-une-batchnorm-puis-transfert-de-poids" class="md-nav__link">
    Fusion d'une Conv \(3\times3\) avec une batchnorm puis transfert de poids
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conversion-dune-conv-1-times-1-en-3-times-3-puis-fusion-avec-la-batchnorm" class="md-nav__link">
    Conversion d'une Conv \(1 \times 1\) en \(3 \times 3\) puis fusion avec la batchnorm.
  </a>
  
    <nav class="md-nav" aria-label="Conversion d'une Conv \(1 \times 1\) en \(3 \times 3\) puis fusion avec la batchnorm.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verification" class="md-nav__link">
    VÃ©rification
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conversion-dune-mathrmid-en-mathrmconv-3-times-3-puis-fusion-avec-la-batchnorm" class="md-nav__link">
    Conversion d'une \(\mathrm{id}\) en \(\mathrm{Conv} 3 \times 3\) puis fusion avec la batchnorm.
  </a>
  
    <nav class="md-nav" aria-label="Conversion d'une \(\mathrm{id}\) en \(\mathrm{Conv} 3 \times 3\) puis fusion avec la batchnorm.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verification_1" class="md-nav__link">
    VÃ©rification
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-grandeur-reelle" class="md-nav__link">
    Test grandeur rÃ©elle
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../bnn/" class="md-nav__link">
        Les BNN
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_9" type="checkbox" id="__nav_2_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_9">
          AlgÃ¨bre tensorielle
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="AlgÃ¨bre tensorielle" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_9">
          <span class="md-nav__icon md-icon"></span>
          AlgÃ¨bre tensorielle
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/algebra/" class="md-nav__link">
        Les tenseurs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/attn/" class="md-nav__link">
        L'attention
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          MLOps
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="MLOps" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          MLOps
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/docker/" class="md-nav__link">
        Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/DVC/" class="md-nav__link">
        Data versioning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/mlem/" class="md-nav__link">
        Model Registry
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/featurestore/" class="md-nav__link">
        Feature store
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/hydra/" class="md-nav__link">
        Hydra
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/monitoring/" class="md-nav__link">
        Monitoring
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/optuna/" class="md-nav__link">
        Optimisation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/image_fastapi/" class="md-nav__link">
        REST API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          AzureML
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="AzureML" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          AzureML
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/lesson1/" class="md-nav__link">
        SDK Azure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/lesson1_project/" class="md-nav__link">
        HyperDrive et AutoML
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/lesson2/" class="md-nav__link">
        DÃ©ployer un modÃ¨le
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/lesson3/" class="md-nav__link">
        Utilisation du modÃ¨le dÃ©ployÃ©
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/lesson4/" class="md-nav__link">
        Pipelines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/annex1/" class="md-nav__link">
        Azure et Traefik
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/annex2/" class="md-nav__link">
        Azure et Caddy
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          DevOps 101
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="DevOps 101" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          DevOps 101
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/linux/" class="md-nav__link">
        Linux Basics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/git/" class="md-nav__link">
        Git
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/shell/" class="md-nav__link">
        Shell scripts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/network/" class="md-nav__link">
        Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/applications/" class="md-nav__link">
        Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/web_server/" class="md-nav__link">
        Web Servers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/terminal/" class="md-nav__link">
        Terminal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/tls_ssl/" class="md-nav__link">
        SSL et TLS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/docker/" class="md-nav__link">
        Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/kubernetes/" class="md-nav__link">
        Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/yaml/" class="md-nav__link">
        YAML
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/redis/" class="md-nav__link">
        Redis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/az_devops/" class="md-nav__link">
        AzDevOps pipelines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/terraform/" class="md-nav__link">
        Terraform
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          AZ-104
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="AZ-104" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          AZ-104
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../az104/az-ad/" class="md-nav__link">
        Managing Azure Active Directory
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../az104/sub_and_gov/" class="md-nav__link">
        Subscription and Governance
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Guidelines
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Guidelines" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Guidelines
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ide_vscode/conf/" class="md-nav__link">
        IDE vscode
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_2" type="checkbox" id="__nav_7_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_2">
          Documentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Documentation" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_2">
          <span class="md-nav__icon md-icon"></span>
          Documentation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../doc_redaction/mkdocs/" class="md-nav__link">
        MkDocs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../doc_redaction/diagrammes/" class="md-nav__link">
        Diagrammes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_3" type="checkbox" id="__nav_7_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_3">
          Formating, Linting, Type Hinting
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Formating, Linting, Type Hinting" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_3">
          <span class="md-nav__icon md-icon"></span>
          Formating, Linting, Type Hinting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../format_lint_hint/format/" class="md-nav__link">
        Formating
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../format_lint_hint/lint/" class="md-nav__link">
        Linting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../format_lint_hint/hint/" class="md-nav__link">
        Hint
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_4" type="checkbox" id="__nav_7_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_4">
          Tests
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tests" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_4">
          <span class="md-nav__icon md-icon"></span>
          Tests
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/unittests/" class="md-nav__link">
        Test unitaire
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_5" type="checkbox" id="__nav_7_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_5">
          CI/CD
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="CI/CD" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_5">
          <span class="md-nav__icon md-icon"></span>
          CI/CD
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../cicd/precommit/" class="md-nav__link">
        Pre-commit
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_6" type="checkbox" id="__nav_7_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_6">
          Code quality
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Code quality" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_6">
          <span class="md-nav__icon md-icon"></span>
          Code quality
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../code_quality/radon/" class="md-nav__link">
        Radon
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_7" type="checkbox" id="__nav_7_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_7">
          Code security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Code security" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_7">
          <span class="md-nav__icon md-icon"></span>
          Code security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../code_security/bandit/" class="md-nav__link">
        Bandit
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Lectures
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Lectures" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Lectures
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lectures/gradient_centralization/" class="md-nav__link">
        Gradient Centralization
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table des matiÃ¨res">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matiÃ¨res
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#etude-des-poids-des-conv-3-times-3-et-des-batchnorm" class="md-nav__link">
    Etude des poids des Conv \(3 \times 3\) et des BatchNorm
  </a>
  
    <nav class="md-nav" aria-label="Etude des poids des Conv \(3 \times 3\) et des BatchNorm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initialisation-dun-modele" class="md-nav__link">
    Initialisation d'un modÃ¨le
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etude-de-la-couche-convolutive" class="md-nav__link">
    Etude de la couche convolutive
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#etude-de-la-batchnorm" class="md-nav__link">
    Etude de la batchnorm
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fusion-dune-convolution-et-dune-batchnorm" class="md-nav__link">
    Fusion d'une Convolution et d'une batchnorm
  </a>
  
    <nav class="md-nav" aria-label="Fusion d'une Convolution et d'une batchnorm">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nouveau-tenseur-de-poids" class="md-nav__link">
    Nouveau tenseur de poids
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nouveau-tenseur-de-biais" class="md-nav__link">
    Nouveau tenseur de biais
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verification-via-les-developpements-limites" class="md-nav__link">
    VÃ©rification via les dÃ©veloppements limitÃ©s
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#repvgg" class="md-nav__link">
    RepVGG
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fusion-dune-conv-3times3-avec-une-batchnorm-puis-transfert-de-poids" class="md-nav__link">
    Fusion d'une Conv \(3\times3\) avec une batchnorm puis transfert de poids
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conversion-dune-conv-1-times-1-en-3-times-3-puis-fusion-avec-la-batchnorm" class="md-nav__link">
    Conversion d'une Conv \(1 \times 1\) en \(3 \times 3\) puis fusion avec la batchnorm.
  </a>
  
    <nav class="md-nav" aria-label="Conversion d'une Conv \(1 \times 1\) en \(3 \times 3\) puis fusion avec la batchnorm.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verification" class="md-nav__link">
    VÃ©rification
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conversion-dune-mathrmid-en-mathrmconv-3-times-3-puis-fusion-avec-la-batchnorm" class="md-nav__link">
    Conversion d'une \(\mathrm{id}\) en \(\mathrm{Conv} 3 \times 3\) puis fusion avec la batchnorm.
  </a>
  
    <nav class="md-nav" aria-label="Conversion d'une \(\mathrm{id}\) en \(\mathrm{Conv} 3 \times 3\) puis fusion avec la batchnorm.">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verification_1" class="md-nav__link">
    VÃ©rification
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#test-grandeur-reelle" class="md-nav__link">
    Test grandeur rÃ©elle
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>
(function() {
  function addWidgetsRenderer() {
    var requireJsScript = document.createElement('script');
    requireJsScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js';

    var mimeElement = document.querySelector('script[type="application/vnd.jupyter.widget-view+json"]');
    var jupyterWidgetsScript = document.createElement('script');
    var widgetRendererSrc = 'https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js';
    var widgetState;

    // Fallback for older version:
    try {
      widgetState = mimeElement && JSON.parse(mimeElement.innerHTML);

      if (widgetState && (widgetState.version_major < 2 || !widgetState.version_major)) {
        widgetRendererSrc = 'jupyter-js-widgets@*/dist/embed.js';
      }
    } catch(e) {}

    jupyterWidgetsScript.src = widgetRendererSrc;

    document.body.appendChild(requireJsScript);
    document.body.appendChild(jupyterWidgetsScript);
  }

  document.addEventListener('DOMContentLoaded', addWidgetsRenderer);
}());
</script>

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="fusion-conv-bn-et-repvgg">Fusion Conv-BN et RepVGG</h1>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span>
<span class="normal"><a href="#__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Conv2D</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">BatchNormalization</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">GlobalAvgPool2D</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">,</span> <span class="n">ReLU</span><span class="p">,</span> <span class="n">Softmax</span><span class="p">,</span> <span class="n">Dense</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Input</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="kn">from</span> <span class="nn">tensorflow.keras.layers</span> <span class="kn">import</span> <span class="n">Add</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">Model</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">backend</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="n">img_shape</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="etude-des-poids-des-conv-3-times-3-et-des-batchnorm">Etude des poids des Conv <span class="arithmatex">\(3 \times 3\)</span> et des BatchNorm</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Regardons comment s'articulent les poids dans les couches de convolutions et de batchnormalisation.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="initialisation-dun-modele">Initialisation d'un modÃ¨le</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nb">input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">img_shape</span><span class="p">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="n">x</span><span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;he_uniform&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;testing_conv_init&#39;</span><span class="p">)(</span><span class="nb">input</span><span class="p">)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="n">x</span><span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;testing_bn_init&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Model: &#34;model&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_1 (InputLayer)         [(None, 32, 32, 3)]       0         
_________________________________________________________________
testing_conv_init (Conv2D)   (None, 32, 32, 16)        448       
_________________________________________________________________
testing_bn_init (BatchNormal (None, 32, 32, 16)        64        
=================================================================
Total params: 512
Trainable params: 480
Non-trainable params: 32
_________________________________________________________________
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="etude-de-la-couche-convolutive">Etude de la couche convolutive</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">weights_conv</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;testing_conv_init&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="n">weights_conv</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>[array([[[[-0.09736294,  0.01110744,  0.38817808,  0.02365676,
            0.37265095,  0.22067323,  0.44893858, -0.4457162 ,
            0.2723634 ,  0.21101996, -0.42767352,  0.39105812,
           -0.38641602, -0.39619464, -0.12856498,  0.00230291],
          [-0.15622476,  0.08576027, -0.39533868,  0.14336786,
            0.09569708,  0.05594608,  0.05045763, -0.15595007,
           -0.05612397, -0.19001147,  0.2724487 ,  0.3459774 ,
            0.01586419,  0.08192965,  0.32559904,  0.04557905],
          [-0.37503266,  0.05977681, -0.05365878,  0.34279034,
           -0.22699383, -0.20862746,  0.13931164, -0.20776296,
            0.12117836,  0.06501201, -0.28448707,  0.2668244 ,
            0.2704514 , -0.34608564, -0.35193035, -0.3525829 ]],

         [[ 0.11737838,  0.14824674, -0.00563487,  0.3061553 ,
            0.01097953,  0.23561516, -0.4535907 , -0.4175086 ,
            0.4607807 , -0.37212858, -0.30806714,  0.14160755,
            0.24837866,  0.12601265,  0.2622976 ,  0.3263745 ],
          [-0.34101892,  0.31189194, -0.11391068,  0.14759234,
           -0.30657652, -0.13771534,  0.45230624,  0.22417751,
            0.0407432 ,  0.07712099, -0.2991236 , -0.1449846 ,
           -0.00576615,  0.26184592, -0.2169587 , -0.2828556 ],
          [-0.20167324, -0.1357314 , -0.29285318,  0.33294716,
            0.23413381, -0.00896761, -0.31519616,  0.14762929,
           -0.18309683, -0.32602823,  0.10732868, -0.15018934,
           -0.27001262,  0.0079852 , -0.20946455, -0.10388163]],

         [[ 0.2783232 ,  0.05878171, -0.35913152,  0.40182415,
            0.092141  , -0.13399044,  0.03964153,  0.06443217,
            0.46447167, -0.41376618,  0.10037312,  0.42862818,
            0.17965165, -0.13864604,  0.04373595, -0.13044247],
          [-0.45564812, -0.33004287,  0.3405182 ,  0.39920047,
           -0.25907567,  0.15346971, -0.02812734, -0.19346526,
           -0.12104025, -0.4278583 ,  0.23774037,  0.3617756 ,
           -0.0419741 ,  0.09765604, -0.26489764, -0.43987206],
          [ 0.07685599,  0.04646841, -0.06539023,  0.02657837,
            0.44154963,  0.21664849,  0.4601402 ,  0.21062568,
            0.34529766,  0.30855897,  0.40019926, -0.26326853,
           -0.04224968, -0.46108606, -0.37318596, -0.42175823]]],


        [[[-0.3455502 ,  0.46076384, -0.15374777,  0.29009756,
           -0.1667389 ,  0.31607136,  0.26514402,  0.3037739 ,
           -0.0812335 ,  0.23732015,  0.07654181, -0.0679315 ,
           -0.31959674, -0.28597334, -0.10885993,  0.408551  ],
          [ 0.14297041, -0.09827566,  0.40382537, -0.4178524 ,
           -0.01861295, -0.35064167,  0.45108077, -0.12225789,
           -0.29017037,  0.23471412,  0.14587566, -0.36702543,
           -0.3979674 ,  0.29743996, -0.39642572, -0.0245271 ],
          [-0.0504581 ,  0.46684763,  0.37567046,  0.20170256,
           -0.36068565, -0.17110959,  0.30896595,  0.09373525,
           -0.21380827, -0.395913  ,  0.24522027,  0.36945108,
           -0.06558827, -0.4528262 ,  0.08612862,  0.3769413 ]],

         [[-0.06688267,  0.11741361, -0.14751217, -0.01143798,
            0.30352488,  0.23946908,  0.15358987, -0.11050937,
           -0.05894232, -0.22810066,  0.3403059 ,  0.23961261,
           -0.16434652,  0.11093548,  0.00398877, -0.11645409],
          [-0.37574512,  0.3296124 , -0.05067682, -0.09595928,
           -0.2214837 ,  0.35080925, -0.02972579,  0.1532239 ,
            0.18751535, -0.02314931, -0.18395177, -0.03616032,
            0.27149966, -0.4180094 ,  0.28113106,  0.4416559 ],
          [-0.2833048 ,  0.03007612,  0.34248617, -0.24044934,
            0.16455218,  0.15701613,  0.20851544, -0.25038487,
           -0.21328565, -0.23982422,  0.37252668,  0.15518335,
            0.28911796,  0.44327244,  0.14157644,  0.26580074]],

         [[ 0.28428563, -0.18229985, -0.20275667,  0.1955097 ,
           -0.3543805 , -0.14616191,  0.28929475,  0.14749238,
            0.2464734 , -0.46400836, -0.02009585,  0.3317866 ,
           -0.20362425, -0.42040807, -0.17440939, -0.01986095],
          [ 0.44240263,  0.1606206 , -0.4160647 ,  0.27185783,
            0.06790957, -0.32414603, -0.23126818, -0.29003426,
            0.12488225,  0.16395304, -0.3259102 , -0.38798535,
           -0.43922648, -0.3790248 ,  0.12847778,  0.13634267],
          [-0.02119684,  0.28930375, -0.4681574 ,  0.28300878,
            0.40201846,  0.1442084 ,  0.19728747, -0.02722415,
            0.42741737, -0.21063939,  0.42403385,  0.3592575 ,
           -0.20373034, -0.4468028 , -0.08656737, -0.20087367]]],


        [[[ 0.02782702,  0.01967528,  0.07292607,  0.389165  ,
            0.36987802,  0.18188533,  0.04504755,  0.41210625,
            0.01592982, -0.11140019, -0.11948159,  0.10680953,
           -0.11324027,  0.39144352, -0.35009858,  0.26030532],
          [ 0.09090939, -0.09534436,  0.03001484, -0.1512312 ,
           -0.3052565 ,  0.3308485 , -0.24254534, -0.10194659,
            0.00120181,  0.38111654,  0.21856287,  0.32130632,
           -0.33506405,  0.44324157,  0.32223514, -0.2681678 ],
          [ 0.4114515 , -0.40250486,  0.3429939 , -0.2685476 ,
            0.37336466,  0.18623039, -0.23775014,  0.18628749,
           -0.07814869,  0.15818772, -0.21979165, -0.44143543,
           -0.09982735, -0.17906868, -0.11419335, -0.10601136]],

         [[-0.04968157,  0.33098873, -0.35580167,  0.19270661,
            0.33699194,  0.41285995,  0.23392567,  0.4191365 ,
           -0.04616675,  0.22136435, -0.29591143,  0.20710972,
           -0.3502412 , -0.10524371, -0.32441103,  0.35304728],
          [-0.45383817, -0.21678528,  0.13484439, -0.23379093,
           -0.038737  ,  0.02832112, -0.36996582, -0.19088644,
            0.32281145,  0.14254984,  0.24848273,  0.3904991 ,
           -0.41010976, -0.4470079 , -0.13003865, -0.41824162],
          [ 0.14215276,  0.29101995, -0.40439036, -0.43802816,
            0.33089224, -0.34787324,  0.32901898, -0.11648187,
           -0.07495171,  0.4408585 ,  0.24113259, -0.08504415,
            0.0623028 ,  0.23243883, -0.19044554,  0.3553057 ]],

         [[-0.09105429,  0.30605808,  0.41014054,  0.33675548,
           -0.05541334,  0.1684458 , -0.12973395, -0.1533834 ,
           -0.00280687, -0.07284549,  0.35922107,  0.09879085,
            0.43200687,  0.02035648,  0.36917636, -0.4091605 ],
          [-0.22962008,  0.13721845, -0.12232229, -0.2520702 ,
            0.07350466,  0.042968  ,  0.31936017,  0.36257067,
           -0.10858962, -0.18460804, -0.1590521 , -0.47047156,
           -0.1503287 , -0.04001006, -0.11763006, -0.24719194],
          [-0.32062727,  0.13543853,  0.0306963 , -0.16442779,
           -0.37330386,  0.13838956,  0.03568128, -0.2321063 ,
            0.07501194, -0.426333  ,  0.00162551,  0.04697415,
           -0.20748636, -0.30767232,  0.43708238, -0.16146705]]]],
       dtype=float32),
 array([0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
       dtype=float32)]</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Les poids forment une liste de deux Ã©lements : les poids des noyaux de convolutions et les biais. La mÃ©thode d'initalisation utilisÃ©e ici est <code>he_uniform</code>, dÃ©veloppÃ©e dans l'article <a href="https://arxiv.org/abs/1502.01852">Delving Deep into Rectifiers: Surpassing Human-Level Performance on ImageNet Classification</a></p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nb">type</span><span class="p">(</span><span class="n">weights_conv</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>list</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nb">len</span><span class="p">(</span><span class="n">weights_conv</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>2</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Les poids dans une couche convolutive sont une liste de deux Ã©lÃ©ments : 
- <code>weights[0]</code> correspond aux poids des noyaux de convolution,
- <code>weights[1]</code> correspond aux biais.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nb">type</span><span class="p">(</span><span class="n">weights_conv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>numpy.ndarray</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">weights_conv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> 
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>(3, 3, 3, 16)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Les axes du tenseur de poids suivent les dimensions suivantes :</p>
<ul>
<li>kernel_size1 : hauteur du kernel,</li>
<li>kernel_size2 : largeur du kernel,</li>
<li>channels_in : nombre des feature maps en entrÃ©e, </li>
<li>channels_out : nombres de features maps (filters) en sortie.</li>
</ul>
<p><code>channels_out</code> est dÃ©finie dans la couche convolutive via le paramÃ¨tres <code>filters</code>, alors que la valeur <code>channels_in</code> est elle directement dÃ©terminÃ©e par le tenseur en entrÃ©e. C'est une diffÃ©rence de TensorFlow par rapport Ã  Pytorch oÃ¹ <code>channels_in</code> et <code>channels_out</code> sont tous les deux des paramÃ¨tres des couches convolutives.</p>
<p>Ainsi, si l'on veut voir les poids du noyau de convolution par rapport au canal <span class="arithmatex">\(0\)</span> en la feature map de sortie <span class="arithmatex">\(5\)</span>, on les obtient en regardant :</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="n">weights_conv</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>array([[ 0.22067323,  0.23561516, -0.13399044],
       [ 0.31607136,  0.23946908, -0.14616191],
       [ 0.18188533,  0.41285995,  0.1684458 ]], dtype=float32)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Par dÃ©faut, les biais des couches de convolutions sont tous initialisÃ©s Ã  zÃ©ro.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="n">weights_conv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>array([0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
      dtype=float32)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="etude-de-la-batchnorm">Etude de la batchnorm</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">weights_bn</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;testing_bn_init&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="n">weights_bn</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>[array([1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.],
       dtype=float32),
 array([0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
       dtype=float32),
 array([0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.],
       dtype=float32),
 array([1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.],
       dtype=float32)]</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="nb">type</span><span class="p">(</span><span class="n">weights_bn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>list</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="nb">len</span><span class="p">(</span><span class="n">weights_bn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>4</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Dans une couche de Batchnormalization, on a 4 types de poids.</p>
<ul>
<li>Les deux paramÃ¨tres de scaling <span class="arithmatex">\(\gamma\)</span> et de biais <span class="arithmatex">\(\beta\)</span>.</li>
<li>Les deux paramÃ¨tres correspondant Ã  la moyenne <span class="arithmatex">\(\mu\)</span> et la variance <span class="arithmatex">\(\sigma\)</span>.</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Tous ces paramÃ¨tres ne sont pas entraÃ®nables, comme on peut le voir dans la liste suivante.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="p">[(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">trainable</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;testing_bn_init&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">variables</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="n">backend</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;testing_bn_init&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>&lt;tf.Tensor: shape=(2,), dtype=int32, numpy=array([ 4, 16], dtype=int32)&gt;</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Les <span class="arithmatex">\(4\)</span> paramÃ¨tres sont tous des vecteurs de dimension <span class="arithmatex">\(16\)</span>, ce qui correspond au nombre de feature maps en sortie de la couche convolutive. </p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="fusion-dune-convolution-et-dune-batchnorm">Fusion d'une Convolution et d'une batchnorm</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>La fusion d'une couche de convolution avec une couche de batchnorm ressort les poids et biais d'une nouvelle couche de convolution avec les noyaux de convolutions de mÃªme dimension.</p>
<p>Etant donnÃ© le tenseur <span class="arithmatex">\(W\)</span> de poids des noyaux de convolution d'une couche convolutive et le tenseur de <span class="arithmatex">\(4\)</span> paramÃ¨tres <span class="arithmatex">\(B=(\gamma, \beta, \mu, \sigma)\)</span> d'une couche de batchnormalization, on obtient les nouveaux poids et poids de la nouvelle couche convolutive via les formules suivantes.</p>
<div class="arithmatex">\[
\widehat{W}_{:,:,:,j} := \frac{\gamma_{j} \cdot W_{:,:,:,j}}{\sqrt{\sigma_{j} + \epsilon}}
\]</div>
<div class="arithmatex">\[
b_{j} = \beta_{j} - \frac{\mu_{j}\cdot\gamma_{j}}{\sqrt{\sigma_{j} + \epsilon}} 
\]</div>
<p>On remarque ici que le biais de la nouvelle couche de convolution ne dÃ©pend que des paramÃ¨tres de la couche de batchnorm. <strong>Ce qui est cohÃ©rent avec la pratique de ne jamais mettre de biais dans une couche de convolution lorsqu'elle est suivie par une couche de batchnorm</strong>.</p>
<p><strong>Remarque</strong> : le <span class="arithmatex">\(\epsilon\)</span> prÃ©sent ici est pour s'assurer que l'on ne divise jamais pas zÃ©ro, dans la pratique il est fixÃ© Ã  <span class="arithmatex">\(0,001\)</span>.</p>
<p>Ce qui nous donne, dans la pratique la fonction suivante.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered celltag_function">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span>
<span class="normal"><a href="#__codelineno-15-18">18</a></span>
<span class="normal"><a href="#__codelineno-15-19">19</a></span>
<span class="normal"><a href="#__codelineno-15-20">20</a></span>
<span class="normal"><a href="#__codelineno-15-21">21</a></span>
<span class="normal"><a href="#__codelineno-15-22">22</a></span>
<span class="normal"><a href="#__codelineno-15-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1"># https://scortex.io/batch-norm-folding-an-easy-way-to-improve-your-network-speed/</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="c1"># https://github.com/DingXiaoH/RepVGG/blob/4da799e33c890c624bfb484b2c35abafd327ba40/repvgg.py#L68</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="k">def</span> <span class="nf">fuse_bn_conv</span><span class="p">(</span><span class="n">weights_conv</span><span class="p">,</span> <span class="n">weights_bn</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>    <span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weights_bn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">weights_bn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a>    <span class="n">beta</span> <span class="o">=</span> <span class="n">weights_bn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a>    <span class="n">mean</span> <span class="o">=</span> <span class="n">weights_bn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a>    <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weights_bn</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">weights_bn</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a>    <span class="n">new_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights_conv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">gamma</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a>    <span class="n">new_bias</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">-</span> <span class="n">mean</span><span class="o">*</span><span class="n">gamma</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a>    <span class="n">new_bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_bias</span><span class="p">,</span> <span class="n">weights_bn</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<a id="__codelineno-15-14" name="__codelineno-15-14"></a>
<a id="__codelineno-15-15" name="__codelineno-15-15"></a>    <span class="k">return</span> <span class="n">new_weights</span><span class="p">,</span> <span class="n">new_bias</span>
<a id="__codelineno-15-16" name="__codelineno-15-16"></a>
<a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="c1"># In the code above, the reshaping is necessary to prevent a mistake if the dimension of the output O was the same as the dimension of the input I. </span>
<a id="__codelineno-15-18" name="__codelineno-15-18"></a>
<a id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="c1"># def get_equivalent_kernel_bias(self):</span>
<a id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="c1">#    kernel3x3, bias3x3 = self._fuse_bn_tensor(self.rbr_dense)</span>
<a id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="c1">#    kernel1x1, bias1x1 = self._fuse_bn_tensor(self.rbr_1x1)</span>
<a id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="c1">#    kernelid, biasid = self._fuse_bn_tensor(self.rbr_identity)</span>
<a id="__codelineno-15-23" name="__codelineno-15-23"></a><span class="c1">#    return kernel3x3 + self._pad_1x1_to_3x3_tensor(kernel1x1) + kernelid, bias3x3 + bias1x1 + biasid</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>DÃ©taillons la fonction ci dessus.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="nouveau-tenseur-de-poids">Nouveau tenseur de poids</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Discutons premiÃ¨rement de la formulation du nouveau tenseur de poids, et voyons pourquoi on modifie la forme de vecteurs <span class="arithmatex">\(\gamma\)</span> et <span class="arithmatex">\(\sigma\)</span>.</p>
<p><span class="arithmatex">\(W_{:,:,:,j}\)</span> correspond dans la formule au noyau de convolution complet de la <span class="arithmatex">\(j\)</span>-iÃ¨me feature map de sortie.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="n">weights_conv</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;testing_conv_init&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="n">weights_conv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>(3, 3, 3, 16)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>On a <span class="arithmatex">\(16\)</span> noyaux de convolution, chacun de dimensions <span class="arithmatex">\((3,3,3)\)</span>. Par exemple, pour <span class="arithmatex">\(j=1\)</span>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="n">weights_conv</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:,:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>(3, 3, 3)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Les vecteur <span class="arithmatex">\(\gamma\)</span> et <span class="arithmatex">\(\sigma\)</span> Ã©tant des vecteurs de dimension <span class="arithmatex">\(16\)</span>, on va les "transformer en tenseur" de dimensions <span class="arithmatex">\((1,1,1,16)\)</span> pour bien faire correspondre le produit suivant chaque axe.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weights_bn</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">weights_bn</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="n">variance</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>(1, 1, 1, 16)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="n">gamma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weights_bn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">weights_bn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="n">gamma</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>(1, 1, 1, 16)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img alt="screen" src="../images/fuse_conv_bn.svg" /></p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Au final, la formule</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="n">new_weights</span> <span class="o">=</span> <span class="p">(</span><span class="n">weights_conv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">gamma</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>rÃ©sume tout cela, tous les tenseurs ayant le nombre d'axes, les opÃ©rations sont vectorisÃ©es et se font axe par axe.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="nouveau-tenseur-de-biais">Nouveau tenseur de biais</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Le opÃ©rations de <code>reshape</code> n'ont pas ajouter de nouveaux scalaires, juste des axes, le calcul du biais se fait alors Ã©lÃ©ment par Ã©lÃ©ment pour tout <span class="arithmatex">\(j\)</span>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="verification-via-les-developpements-limites">VÃ©rification via les dÃ©veloppements limitÃ©s</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>CrÃ©ons un tenseur de poids <span class="arithmatex">\(W\)</span> repÃ©resentatif du noyau d'une convolution et un tenseur de poids <span class="arithmatex">\(B=(\gamma, \beta, \mu, \sigma)\)</span> reprÃ©sentatif des coefficients d'une batchnormalization.</p>
<p>Pour vÃ©rifier si tout marche bien, fixons volontairement le tenseur poids comme un tenseur de dimensions <span class="arithmatex">\((3,3,4,5)\)</span>, la dimension du noyau est toujours fixÃ© Ã  <span class="arithmatex">\((3,3)\)</span> dans RepVGG, seules les dimensions <code>channels_in</code> et <code>channels_out</code> peuvent changer.</p>
<p>Tous les coefficients du tenseur de poids seront fixÃ©s Ã  <span class="arithmatex">\(1\)</span>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="n">conv_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="n">conv_weights</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>(3, 3, 4, 5)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>La dimension <code>channels_out</code> ayant Ã©tÃ© fixÃ©e Ã  <span class="arithmatex">\(5\)</span>, les vecteurs de la batchnormalization seront tous des vecteurs de dimension <span class="arithmatex">\(5\)</span>. Fixons les coefficients suivants.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered celltag_function">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span>
<span class="normal"><a href="#__codelineno-22-3">3</a></span>
<span class="normal"><a href="#__codelineno-22-4">4</a></span>
<span class="normal"><a href="#__codelineno-22-5">5</a></span>
<span class="normal"><a href="#__codelineno-22-6">6</a></span>
<span class="normal"><a href="#__codelineno-22-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="k">def</span> <span class="nf">batchnorm_variables</span><span class="p">(</span><span class="n">gamma_coef</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">beta_coef</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">mu_coef</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma_coef</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a>    <span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma_coef</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a>    <span class="n">beta</span> <span class="o">=</span> <span class="n">beta_coef</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a>    <span class="n">mu</span> <span class="o">=</span> <span class="n">mu_coef</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a>    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma_coef</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a>    <span class="k">return</span> <span class="p">[</span><span class="n">gamma</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="n">conv</span><span class="p">,</span> <span class="n">bn</span> <span class="o">=</span> <span class="n">fuse_bn_conv</span><span class="p">([</span><span class="n">conv_weights</span><span class="p">],</span> <span class="n">batchnorm_variables</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Par dÃ©finition, le nouveau tenseur de poids <span class="arithmatex">\(\widehat{W}\)</span> de la convolution rÃ©sultant de la fusion de l'ancienne convolution et de la batchnorm est donnÃ© par formule suivante.</p>
<div class="arithmatex">\[
\widehat{W}_{:,:,:,j} := \frac{\gamma_{j} \cdot W_{:,:,:,j}}{\sqrt{\sigma_{j} + \epsilon}}
\]</div>
<p>De faÃ§on gÃ©nÃ©rale, pour <span class="arithmatex">\(\gamma_{j}, \sigma_{j}\)</span>, on a le dÃ©veloppement limitÃ© suivant.</p>
<div class="arithmatex">\[
\widehat{W}_{:,:,:,j} := \frac{\gamma_{j} \cdot W_{:,:,:,j}}{\sqrt{\sigma_{j} + \epsilon}} = \frac{\gamma_{j}}{\sqrt{\sigma_{j}}}\left[1- \frac{1}{2\sigma_{j}}\epsilon + o(\epsilon^{2})\right]W_{:,:,:,j} 
\]</div>
<p>Dans notre cas, <span class="arithmatex">\(\forall j, \gamma_{j} = 1, \sigma_{j} = 4\)</span> d'oÃ¹</p>
<div class="arithmatex">\[
\widehat{W}_{:,:,:,j} := \frac{W_{:,:,:,j}}{\sqrt{4 + \epsilon}} = \left[\frac{1}{2}- \frac{1}{16}\epsilon + o(\epsilon^{2})\right]W_{:,:,:,j} \simeq \left[\frac{1}{2}- \frac{1}{16}\epsilon\right]W_{:,:,:,j}
\]</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered celltag_function">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1">1</a></span>
<span class="normal"><a href="#__codelineno-24-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="k">def</span> <span class="nf">compute_scaling_weight_factor</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>    <span class="k">return</span> <span class="n">gamma</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mf">0.001</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">1</a></span>
<span class="normal"><a href="#__codelineno-25-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="n">scale</span> <span class="o">=</span> <span class="n">compute_scaling_weight_factor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="n">scale</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>0.4999375</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="n">conv</span><span class="p">[:,:,:,</span><span class="mi">4</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>array([[[0.49993751, 0.49993751, 0.49993751, 0.49993751],
        [0.49993751, 0.49993751, 0.49993751, 0.49993751],
        [0.49993751, 0.49993751, 0.49993751, 0.49993751]],

       [[0.49993751, 0.49993751, 0.49993751, 0.49993751],
        [0.49993751, 0.49993751, 0.49993751, 0.49993751],
        [0.49993751, 0.49993751, 0.49993751, 0.49993751]],

       [[0.49993751, 0.49993751, 0.49993751, 0.49993751],
        [0.49993751, 0.49993751, 0.49993751, 0.49993751],
        [0.49993751, 0.49993751, 0.49993751, 0.49993751]]])</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ce qui correspond bien Ã  l'approximation obtenue par dÃ©veloppement limitÃ©. On peut par exemple vÃ©rifier si <span class="arithmatex">\(\widehat{W}\)</span> est approximativement Ã©gal Ã  <code>conv</code> Ã  <span class="arithmatex">\(10^{-3}\)</span> avec la commande <code>np.isclose</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span>
<span class="normal"><a href="#__codelineno-27-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="n">conv_weights_real</span> <span class="o">=</span> <span class="n">scale</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="n">conv_weights_real</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>array([[[0.4999375, 0.4999375, 0.4999375, 0.4999375],
        [0.4999375, 0.4999375, 0.4999375, 0.4999375],
        [0.4999375, 0.4999375, 0.4999375, 0.4999375]],

       [[0.4999375, 0.4999375, 0.4999375, 0.4999375],
        [0.4999375, 0.4999375, 0.4999375, 0.4999375],
        [0.4999375, 0.4999375, 0.4999375, 0.4999375]],

       [[0.4999375, 0.4999375, 0.4999375, 0.4999375],
        [0.4999375, 0.4999375, 0.4999375, 0.4999375],
        [0.4999375, 0.4999375, 0.4999375, 0.4999375]]])</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Si <code>np.mean(...)</code> <span class="arithmatex">\(&lt; 1\)</span> alors le calcul est faux.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span> <span class="n">conv_weights_real</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>1.0</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Pour le biais, on a la formule suivante.</p>
<div class="arithmatex">\[
b_{j} = \beta_{j} - \frac{\mu_{j}\cdot\gamma_{j}}{\sqrt{\sigma_{j} + \epsilon}} = \beta_{j} - \frac{\mu_{j}\cdot\gamma_{j}}{\sqrt{\sigma_{j}}}\left[1- \frac{1}{2\sigma_{j}}\epsilon + o(\epsilon^{2})\right]
\]</div>
<p>dans notre cas, on a :</p>
<ul>
<li><span class="arithmatex">\(\beta_{j} = 2\)</span>,</li>
<li><span class="arithmatex">\(\gamma_{j} = 1\)</span>,</li>
<li><span class="arithmatex">\(\mu_{j} = 1\)</span>,</li>
<li><span class="arithmatex">\(\sigma_{j} = 4\)</span>.</li>
</ul>
<div class="arithmatex">\[
b_{j} = 2 - \frac{1}{2}\left[1- \frac{1}{8}\epsilon + o(\epsilon^{2})\right] \simeq 2 - \frac{1}{2} - \frac{1}{16}\epsilon
\]</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered celltag_function">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span>
<span class="normal"><a href="#__codelineno-29-2">2</a></span>
<span class="normal"><a href="#__codelineno-29-3">3</a></span>
<span class="normal"><a href="#__codelineno-29-4">4</a></span>
<span class="normal"><a href="#__codelineno-29-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="k">def</span> <span class="nf">compute_scaling_bias_factor</span><span class="p">(</span><span class="n">gamma</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a>    <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="n">gamma</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a>    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">0.001</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma</span><span class="p">)</span>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a>
<a id="__codelineno-29-5" name="__codelineno-29-5"></a>    <span class="k">return</span> <span class="n">beta</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">b</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span>
<span class="normal"><a href="#__codelineno-30-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="n">bias_scale</span> <span class="o">=</span> <span class="n">compute_scaling_bias_factor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="n">bias_scale</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="n">bn</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>array([1.50006249, 1.50006249, 1.50006249, 1.50006249, 1.50006249])</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="n">bn_real</span> <span class="o">=</span> <span class="n">bias_scale</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bn_real</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>1.0</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="repvgg">RepVGG</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img alt="screen" src="../images/repvgg.svg" /></p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img alt="screen" src="../images/repvgg2.svg" /></p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Les couches convolutives dans RepVGG n'ayant que des noyaux <span class="arithmatex">\(3\times3\)</span> ou <span class="arithmatex">\(1\times1\)</span>, on ne se prÃ©occupe que de cela dans la suite.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="fusion-dune-conv-3times3-avec-une-batchnorm-puis-transfert-de-poids">Fusion d'une Conv <span class="arithmatex">\(3\times3\)</span> avec une batchnorm puis transfert de poids</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>CrÃ©ons un modÃ¨le simple : une couche convolutive suivi d'une couche de batchnormalisation, pour simplifier on ne condiÃ¨re aucune couche d'activation (qui de toute faÃ§on ne rentre pas en jeu). Nous allons :</p>
<ol>
<li>Fusionner les deux couches pour crÃ©er un nouveau tenseur (poids, biais)</li>
<li>TransfÃ©rer ce nouveau tensor dans un modÃ¨le plus simple <code>model_after_fusion</code>.</li>
</ol>
<p><strong>Remarque</strong> : la convolution dans <code>model_after_fusion</code> utilise elle bien un biais (<code>use_bias = True</code>).</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1">1</a></span>
<span class="normal"><a href="#__codelineno-33-2">2</a></span>
<span class="normal"><a href="#__codelineno-33-3">3</a></span>
<span class="normal"><a href="#__codelineno-33-4">4</a></span>
<span class="normal"><a href="#__codelineno-33-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="nb">input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">img_shape</span><span class="p">)</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="n">x</span><span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;he_uniform&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv&#39;</span><span class="p">)(</span><span class="nb">input</span><span class="p">)</span>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="n">x</span><span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;bn&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="n">model_before_fusion</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="n">model_before_fusion</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Model: &#34;model_1&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_2 (InputLayer)         [(None, 32, 32, 3)]       0         
_________________________________________________________________
conv (Conv2D)                (None, 32, 32, 16)        432       
_________________________________________________________________
bn (BatchNormalization)      (None, 32, 32, 16)        64        
=================================================================
Total params: 496
Trainable params: 464
Non-trainable params: 32
_________________________________________________________________
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">1</a></span>
<span class="normal"><a href="#__codelineno-34-2">2</a></span>
<span class="normal"><a href="#__codelineno-34-3">3</a></span>
<span class="normal"><a href="#__codelineno-34-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="nb">input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">img_shape</span><span class="p">)</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="n">x</span><span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;he_normal&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv&#39;</span><span class="p">)(</span><span class="nb">input</span><span class="p">)</span>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="n">model_after_fusion</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="n">model_after_fusion</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Model: &#34;model_2&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_3 (InputLayer)         [(None, 32, 32, 3)]       0         
_________________________________________________________________
conv (Conv2D)                (None, 32, 32, 16)        448       
=================================================================
Total params: 448
Trainable params: 448
Non-trainable params: 0
_________________________________________________________________
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1">1</a></span>
<span class="normal"><a href="#__codelineno-35-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="n">weights_1</span> <span class="o">=</span> <span class="n">model_before_fusion</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;conv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="n">weights_2</span> <span class="o">=</span> <span class="n">model_after_fusion</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;conv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weights_1</span><span class="o">-</span><span class="n">weights_2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>0.0023266133</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1">1</a></span>
<span class="normal"><a href="#__codelineno-37-2">2</a></span>
<span class="normal"><a href="#__codelineno-37-3">3</a></span>
<span class="normal"><a href="#__codelineno-37-4">4</a></span>
<span class="normal"><a href="#__codelineno-37-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="n">conv</span> <span class="o">=</span> <span class="n">model_before_fusion</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;conv&quot;</span><span class="p">)</span>
<a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="n">bn</span> <span class="o">=</span> <span class="n">model_before_fusion</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;bn&quot;</span><span class="p">)</span>
<a id="__codelineno-37-3" name="__codelineno-37-3"></a>
<a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="n">conv_weights</span><span class="p">,</span> <span class="n">conv_biases</span> <span class="o">=</span> <span class="n">fuse_bn_conv</span><span class="p">(</span><span class="n">conv</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(),</span> <span class="n">bn</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
<a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="n">model_after_fusion</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;conv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_weights</span><span class="p">([</span><span class="n">conv_weights</span><span class="p">,</span> <span class="n">conv_biases</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>VÃ©rifions que la mise en place des nouveaux poids s'est bien passÃ©e, ie que l'opÃ©ration <code>set_weights()</code> n'a rien ajoutÃ© de supplÃ©mtentaire. Si tout se passe bien, <code>np.mean</code> ne devrait renvoyer que des <code>1.0</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1">1</a></span>
<span class="normal"><a href="#__codelineno-38-2">2</a></span>
<span class="normal"><a href="#__codelineno-38-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="n">w0</span><span class="p">,</span> <span class="n">b0</span> <span class="o">=</span> <span class="n">fuse_bn_conv</span><span class="p">(</span><span class="n">model_before_fusion</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;conv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(),</span> <span class="n">model_before_fusion</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;bn&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
<a id="__codelineno-38-2" name="__codelineno-38-2"></a>
<a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="n">w1</span><span class="p">,</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">model_after_fusion</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;conv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">w0</span> <span class="o">==</span> <span class="n">w1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>1.0</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">b0</span> <span class="o">==</span> <span class="n">b1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>1.0</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Donc tout s'est bien passÃ©. Reste maintenant Ã  gÃ©nÃ©raliser cette transformation.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>L'idÃ©e de RepVGG est d'utiliser une architecture Ã  la ResNet pour l'entraÃ®nement, avec des skips connections, puis lors du dÃ©ploiement du modÃ¨le de reparamÃ©trer les skips connections via des fusions Conv-BN afin de plus avoir qu'une architecture linÃ©aire Ã  la VGG, beaucoup plus rapide en infÃ©rence qu'une architecture Ã  la ResNet.</p>
<p>En plus de fusionner des <span class="arithmatex">\(\mathrm{Conv} 3 \times 3\)</span> avec des <span class="arithmatex">\(\mathrm{BN}\)</span>, il est aussi nÃ©cessaire de savoir faire les opÃ©rations suivantes.</p>
<ol>
<li>Convertir une <span class="arithmatex">\(\mathrm{Conv} 1 \times 1\)</span> en <span class="arithmatex">\(\mathrm{Conv} 3 \times 3\)</span> puis la fusionner avec la <span class="arithmatex">\(\mathrm{BN}\)</span> correspondante.</li>
<li>Convertir une <span class="arithmatex">\(\mathrm{id}\)</span> en <span class="arithmatex">\(\mathrm{Conv} 3 \times 3\)</span> puis la fusionner avec la <span class="arithmatex">\(\mathrm{BN}\)</span> correspondante.</li>
</ol>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="conversion-dune-conv-1-times-1-en-3-times-3-puis-fusion-avec-la-batchnorm">Conversion d'une Conv <span class="arithmatex">\(1 \times 1\)</span> en <span class="arithmatex">\(3 \times 3\)</span> puis fusion avec la batchnorm.</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Pour convertir une conv 1x1 en conv 3x3 les nombres de canaux en entrÃ©e et en sortie importe peu, ce qu'il faut c'est modifier la dimension des noyaux de convolutions pour passer d'une dimension 1x1 Ã  3x3, et pour cela on utilise un padding.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span>
<span class="normal"><a href="#__codelineno-41-2">2</a></span>
<span class="normal"><a href="#__codelineno-41-3">3</a></span>
<span class="normal"><a href="#__codelineno-41-4">4</a></span>
<span class="normal"><a href="#__codelineno-41-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="nb">input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">img_shape</span><span class="p">)</span>
<a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="n">x</span><span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;he_uniform&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv&#39;</span><span class="p">)(</span><span class="nb">input</span><span class="p">)</span>
<a id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="n">x</span><span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;bn&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="n">model_before_fusion_conv1</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="n">model_before_fusion_conv1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Model: &#34;model_3&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_4 (InputLayer)         [(None, 32, 32, 3)]       0         
_________________________________________________________________
conv (Conv2D)                (None, 32, 32, 16)        48        
_________________________________________________________________
bn (BatchNormalization)      (None, 32, 32, 16)        64        
=================================================================
Total params: 112
Trainable params: 80
Non-trainable params: 32
_________________________________________________________________
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1">1</a></span>
<span class="normal"><a href="#__codelineno-42-2">2</a></span>
<span class="normal"><a href="#__codelineno-42-3">3</a></span>
<span class="normal"><a href="#__codelineno-42-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="nb">input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">img_shape</span><span class="p">)</span>
<a id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="n">x</span><span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">use_bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;he_normal&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv&#39;</span><span class="p">)(</span><span class="nb">input</span><span class="p">)</span>
<a id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="n">model_after_fusion_conv1</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="n">model_after_fusion_conv1</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Model: &#34;model_4&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_5 (InputLayer)         [(None, 32, 32, 3)]       0         
_________________________________________________________________
conv (Conv2D)                (None, 32, 32, 16)        448       
=================================================================
Total params: 448
Trainable params: 448
Non-trainable params: 0
_________________________________________________________________
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1">1</a></span>
<span class="normal"><a href="#__codelineno-43-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="n">weights_conv1</span> <span class="o">=</span> <span class="n">model_before_fusion_conv1</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;conv&#39;</span><span class="p">)</span>
<a id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="n">weights_bn1</span> <span class="o">=</span> <span class="n">model_before_fusion_conv1</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;bn&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="n">weights_conv1</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>(1, 1, 3, 16)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>La premiÃ¨re chose Ã  faire, c'est de transformer les noyaux de convolution <span class="arithmatex">\(1\times1\)</span> en des noyaux de convolution <span class="arithmatex">\(3\times3\)</span>. Pour faire cela, on utilise la notion de "padding", dÃ©jÃ  utilisÃ©e dans le cas des convolutions.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="n">weights_conv1</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">][:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>array([[-1.227452]], dtype=float32)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>On a deux fonctions possibles pour faire Ã§a. On peut utiliser soit la fonction de tensorflow.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="n">padded_conv1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">weights_conv1</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;CONSTANT&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Soit la fonction de numpy.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="n">padded_conv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">weights_conv1</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pad_width</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Dans les deux cas, on a un paramÃ¨tre donnant la taille du padding : <code>[[1,1], [1, 1], [0,0], [0,0]]</code>, c'est une liste de longueur le nombre d'axes du tenseur que l'on souhaite modifier, chaque Ã©lÃ©ment de la liste nous dit de combien on doit agrandir au dÃ©but et Ã  la fin.</p>
<p><code>[[1,1], [1, 1], [0,0], [0,0]] = [[pad_avant_axe1, pad_arriÃ¨re_axe1], [pad_avant_axe2, pad_arriÃ¨re_axe2], [pad_avant_axe3, pad_arriÃ¨re_axe3], [pad_avant_axe4, pad_arriÃ¨re_axe4]]</code></p>
<p>Le dernier paramÃ¨tre nous dit quoi rajouter aux endroits oÃ¹ l'on a agrandi, ici des constantes : la valeur <span class="arithmatex">\(0\)</span>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1">1</a></span>
<span class="normal"><a href="#__codelineno-48-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="n">padded_conv1_tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">weights_conv1</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="s2">&quot;CONSTANT&quot;</span><span class="p">)</span>
<a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="n">padded_conv1_np</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">weights_conv1</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pad_width</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Les deux fonctions donnent le mÃªme rÃ©sultat.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">padded_conv1_tf</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">==</span><span class="n">padded_conv1_np</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>True</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Comme la fonction <code>set_weights()</code> demande d'utiliser des <code>np.array</code>, on va utiliser la fonction de numpy.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered celltag_function">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1">1</a></span>
<span class="normal"><a href="#__codelineno-50-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="k">def</span> <span class="nf">pad_size_one_kernel</span><span class="p">(</span><span class="n">conv_weights</span><span class="p">):</span>    
<a id="__codelineno-50-2" name="__codelineno-50-2"></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">conv_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pad_width</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1">1</a></span>
<span class="normal"><a href="#__codelineno-51-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="n">padded_weights_conv1</span> <span class="o">=</span> <span class="n">pad_size_one_kernel</span><span class="p">(</span><span class="n">weights_conv1</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
<a id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="n">padded_weights_conv1</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>(3, 3, 3, 16)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="verification">VÃ©rification</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>On a transformÃ© tous les noyaux de convolutions <span class="arithmatex">\(1\times1\)</span> en noyaux <span class="arithmatex">\(3\times3\)</span>, chacun des <code>padded_weights_conv1[:,:,i,j]</code> pour <span class="arithmatex">\(0 \leq i \leq 2\)</span> et <span class="arithmatex">\(0 \leq j \leq 15\)</span> doit Ãªtre une matrice <span class="arithmatex">\(3\times3\)</span> oÃ¹ tous les Ã©lÃ©ments sont nuls sauf possiblement celui du milieu.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered celltag_function">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-52-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-52-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-52-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-52-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-52-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-52-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-52-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-52-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-52-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="k">def</span> <span class="nf">test_padded_kernel_conv</span><span class="p">(</span><span class="n">padded_kernel</span><span class="p">):</span>
<a id="__codelineno-52-2" name="__codelineno-52-2"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-52-3" name="__codelineno-52-3"></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
<a id="__codelineno-52-4" name="__codelineno-52-4"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Matrix of size 3x3 : </span><span class="si">{</span><span class="n">padded_kernel</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-52-5" name="__codelineno-52-5"></a>            <span class="n">squared_sum</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-52-6" name="__codelineno-52-6"></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-52-7" name="__codelineno-52-7"></a>                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-52-8" name="__codelineno-52-8"></a>                    <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">l</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-52-9" name="__codelineno-52-9"></a>                        <span class="n">squared_sum</span> <span class="o">+=</span> <span class="n">padded_kernel</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
<a id="__codelineno-52-10" name="__codelineno-52-10"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Squared sum is : </span><span class="si">{</span><span class="n">squared_sum</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="n">test_padded_kernel_conv</span><span class="p">(</span><span class="n">padded_weights_conv1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="n">dummy_conv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="o">*</span><span class="mi">1</span><span class="o">*</span><span class="mi">3</span><span class="o">*</span><span class="mi">16</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1">1</a></span>
<span class="normal"><a href="#__codelineno-55-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="n">padded_dummy_conv</span><span class="o">=</span><span class="n">pad_size_one_kernel</span><span class="p">([</span><span class="n">dummy_conv</span><span class="p">])</span>
<a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="n">test_padded_kernel_conv</span><span class="p">(</span><span class="n">padded_dummy_conv</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
Matrix of size 3x3 : True
Squared sum is : 0.0
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Comme prÃ©cÃ©demment, on vÃ©rifie via les dÃ©veloppements limitÃ©s que Ã§a fonctionne.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="n">conv</span><span class="p">,</span> <span class="n">bn</span> <span class="o">=</span> <span class="n">fuse_bn_conv</span><span class="p">([</span><span class="n">padded_dummy_conv</span><span class="p">],</span> <span class="n">batchnorm_variables</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">16</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1">1</a></span>
<span class="normal"><a href="#__codelineno-57-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1"></a><span class="n">scale</span> <span class="o">=</span> <span class="n">compute_scaling_weight_factor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-57-2" name="__codelineno-57-2"></a><span class="n">scale</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>0.4999375</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-58-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1"></a><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span> <span class="n">scale</span><span class="o">*</span><span class="n">padded_dummy_conv</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>1.0</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-59-1">1</a></span>
<span class="normal"><a href="#__codelineno-59-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1"></a><span class="n">bias_scale</span> <span class="o">=</span> <span class="n">compute_scaling_bias_factor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-59-2" name="__codelineno-59-2"></a><span class="n">bias_scale</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>1.5000625</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-60-1">1</a></span>
<span class="normal"><a href="#__codelineno-60-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1"></a><span class="n">bn_real</span> <span class="o">=</span> <span class="n">bias_scale</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<a id="__codelineno-60-2" name="__codelineno-60-2"></a><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bn_real</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>1.0</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-61-1">1</a></span>
<span class="normal"><a href="#__codelineno-61-2">2</a></span>
<span class="normal"><a href="#__codelineno-61-3">3</a></span>
<span class="normal"><a href="#__codelineno-61-4">4</a></span>
<span class="normal"><a href="#__codelineno-61-5">5</a></span>
<span class="normal"><a href="#__codelineno-61-6">6</a></span>
<span class="normal"><a href="#__codelineno-61-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1"></a><span class="n">weights_conv1</span> <span class="o">=</span> <span class="n">model_before_fusion_conv1</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;conv&#39;</span><span class="p">)</span>
<a id="__codelineno-61-2" name="__codelineno-61-2"></a><span class="n">weights_bn1</span> <span class="o">=</span> <span class="n">model_before_fusion_conv1</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s1">&#39;bn&#39;</span><span class="p">)</span>
<a id="__codelineno-61-3" name="__codelineno-61-3"></a>
<a id="__codelineno-61-4" name="__codelineno-61-4"></a><span class="n">padded_weights_conv1</span> <span class="o">=</span> <span class="n">pad_size_one_kernel</span><span class="p">(</span><span class="n">weights_conv1</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
<a id="__codelineno-61-5" name="__codelineno-61-5"></a><span class="n">conv_weights</span><span class="p">,</span> <span class="n">conv_bias</span> <span class="o">=</span> <span class="n">fuse_bn_conv</span><span class="p">([</span><span class="n">padded_weights_conv1</span><span class="p">],</span> <span class="n">weights_bn1</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
<a id="__codelineno-61-6" name="__codelineno-61-6"></a>
<a id="__codelineno-61-7" name="__codelineno-61-7"></a><span class="n">model_after_fusion_conv1</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s2">&quot;conv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_weights</span><span class="p">([</span><span class="n">conv_weights</span><span class="p">,</span> <span class="n">conv_bias</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="conversion-dune-mathrmid-en-mathrmconv-3-times-3-puis-fusion-avec-la-batchnorm">Conversion d'une <span class="arithmatex">\(\mathrm{id}\)</span> en <span class="arithmatex">\(\mathrm{Conv} 3 \times 3\)</span> puis fusion avec la batchnorm.</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Les branches id ne sont utilisÃ©es dans l'architecture de RepVGG que lorsque la conditions <code>channels_in</code> = <code>channels_out</code> est vÃ©rifiÃ©e, c'est Ã  dire Ã  l'intÃ©rieur de chaque stage entre 2 blocs convolutifs avec un stride de 2.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-62-1">1</a></span>
<span class="normal"><a href="#__codelineno-62-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1"></a><span class="c1"># Fixons le nombre de channels, peut importe le nombre.</span>
<a id="__codelineno-62-2" name="__codelineno-62-2"></a><span class="n">channels</span> <span class="o">=</span> <span class="mi">4</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>An identity mapping can be viewed as a <span class="arithmatex">\(1\times1\)</span> conv with an identity matrix as the kernel.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered celltag_function">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-63-1">1</a></span>
<span class="normal"><a href="#__codelineno-63-2">2</a></span>
<span class="normal"><a href="#__codelineno-63-3">3</a></span>
<span class="normal"><a href="#__codelineno-63-4">4</a></span>
<span class="normal"><a href="#__codelineno-63-5">5</a></span>
<span class="normal"><a href="#__codelineno-63-6">6</a></span>
<span class="normal"><a href="#__codelineno-63-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="k">def</span> <span class="nf">size_three_kernel_from_id</span><span class="p">(</span><span class="n">channels</span><span class="p">):</span>
<a id="__codelineno-63-2" name="__codelineno-63-2"></a>    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
<a id="__codelineno-63-3" name="__codelineno-63-3"></a>    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
<a id="__codelineno-63-4" name="__codelineno-63-4"></a>    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">channels</span><span class="p">,</span><span class="n">channels</span><span class="p">))</span>
<a id="__codelineno-63-5" name="__codelineno-63-5"></a>    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">pad_width</span><span class="o">=</span><span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-63-6" name="__codelineno-63-6"></a>
<a id="__codelineno-63-7" name="__codelineno-63-7"></a>    <span class="k">return</span> <span class="n">kernel</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-64-1">1</a></span>
<span class="normal"><a href="#__codelineno-64-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="n">conv_from_id</span> <span class="o">=</span> <span class="n">size_three_kernel_from_id</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-64-2" name="__codelineno-64-2"></a><span class="n">conv_from_id</span><span class="o">.</span><span class="n">shape</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>(3, 3, 4, 4)</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered celltag_function">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-65-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-65-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-65-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-65-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-65-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-65-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-65-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-65-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-65-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-65-10">10</a></span>
<span class="normal"><a href="#__codelineno-65-11">11</a></span>
<span class="normal"><a href="#__codelineno-65-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="k">def</span> <span class="nf">test_padded_kernel_from_id</span><span class="p">(</span><span class="n">padded_kernel</span><span class="p">):</span>
<a id="__codelineno-65-2" name="__codelineno-65-2"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-65-3" name="__codelineno-65-3"></a>        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span>
<a id="__codelineno-65-4" name="__codelineno-65-4"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Matrix of size 3x3 : </span><span class="si">{</span><span class="n">padded_kernel</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-65-5" name="__codelineno-65-5"></a>            <span class="n">squared_sum</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-65-6" name="__codelineno-65-6"></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-65-7" name="__codelineno-65-7"></a>                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
<a id="__codelineno-65-8" name="__codelineno-65-8"></a>                    <span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
<a id="__codelineno-65-9" name="__codelineno-65-9"></a>                        <span class="n">squared_sum</span> <span class="o">+=</span> <span class="n">padded_kernel</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
<a id="__codelineno-65-10" name="__codelineno-65-10"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-65-11" name="__codelineno-65-11"></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Middle element is 1 : </span><span class="si">{</span><span class="n">padded_kernel</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-65-12" name="__codelineno-65-12"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Squared sum is : </span><span class="si">{</span><span class="n">squared_sum</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-66-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1"></a><span class="n">test_padded_kernel_from_id</span><span class="p">(</span><span class="n">conv</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
Matrix of size 3x3 : True
Middle element is 1 : False
Squared sum is : 0.0
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-67-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="n">conv</span><span class="p">,</span> <span class="n">bn</span> <span class="o">=</span> <span class="n">fuse_bn_conv</span><span class="p">([</span><span class="n">conv_from_id</span><span class="p">],</span> <span class="n">batchnorm_variables</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">channels</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-68-1">1</a></span>
<span class="normal"><a href="#__codelineno-68-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1"></a><span class="n">scale</span> <span class="o">=</span> <span class="n">compute_scaling_weight_factor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-68-2" name="__codelineno-68-2"></a><span class="n">scale</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>0.4999375</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-69-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1"></a><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">conv</span><span class="p">,</span> <span class="n">scale</span><span class="o">*</span><span class="n">conv_from_id</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>1.0</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-70-1">1</a></span>
<span class="normal"><a href="#__codelineno-70-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1"></a><span class="n">bias_scale</span> <span class="o">=</span> <span class="n">compute_scaling_bias_factor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a id="__codelineno-70-2" name="__codelineno-70-2"></a><span class="n">bias_scale</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>1.5000625</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-71-1">1</a></span>
<span class="normal"><a href="#__codelineno-71-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1"></a><span class="n">bn_real</span> <span class="o">=</span> <span class="n">bias_scale</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
<a id="__codelineno-71-2" name="__codelineno-71-2"></a><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">bn_real</span><span class="p">,</span> <span class="n">bn</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>1.0</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="verification_1">VÃ©rification</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="test-grandeur-reelle">Test grandeur rÃ©elle</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered celltag_function">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-72-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-72-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-72-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-72-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-72-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-72-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-72-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-72-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-72-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-72-10">10</a></span>
<span class="normal"><a href="#__codelineno-72-11">11</a></span>
<span class="normal"><a href="#__codelineno-72-12">12</a></span>
<span class="normal"><a href="#__codelineno-72-13">13</a></span>
<span class="normal"><a href="#__codelineno-72-14">14</a></span>
<span class="normal"><a href="#__codelineno-72-15">15</a></span>
<span class="normal"><a href="#__codelineno-72-16">16</a></span>
<span class="normal"><a href="#__codelineno-72-17">17</a></span>
<span class="normal"><a href="#__codelineno-72-18">18</a></span>
<span class="normal"><a href="#__codelineno-72-19">19</a></span>
<span class="normal"><a href="#__codelineno-72-20">20</a></span>
<span class="normal"><a href="#__codelineno-72-21">21</a></span>
<span class="normal"><a href="#__codelineno-72-22">22</a></span>
<span class="normal"><a href="#__codelineno-72-23">23</a></span>
<span class="normal"><a href="#__codelineno-72-24">24</a></span>
<span class="normal"><a href="#__codelineno-72-25">25</a></span>
<span class="normal"><a href="#__codelineno-72-26">26</a></span>
<span class="normal"><a href="#__codelineno-72-27">27</a></span>
<span class="normal"><a href="#__codelineno-72-28">28</a></span>
<span class="normal"><a href="#__codelineno-72-29">29</a></span>
<span class="normal"><a href="#__codelineno-72-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1"></a><span class="k">def</span> <span class="nf">repvgg_block</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">num_layer</span><span class="p">):</span>
<a id="__codelineno-72-2" name="__codelineno-72-2"></a>
<a id="__codelineno-72-3" name="__codelineno-72-3"></a>    <span class="c1"># main stream</span>
<a id="__codelineno-72-4" name="__codelineno-72-4"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span>
<a id="__codelineno-72-5" name="__codelineno-72-5"></a>        <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
<a id="__codelineno-72-6" name="__codelineno-72-6"></a>        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span>
<a id="__codelineno-72-7" name="__codelineno-72-7"></a>        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-72-8" name="__codelineno-72-8"></a>        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
<a id="__codelineno-72-9" name="__codelineno-72-9"></a>        <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_normal&quot;</span><span class="p">,</span>
<a id="__codelineno-72-10" name="__codelineno-72-10"></a>        <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-72-11" name="__codelineno-72-11"></a>        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;block_</span><span class="si">{</span><span class="n">num_layer</span><span class="si">}</span><span class="s1">_conv_main&#39;</span>
<a id="__codelineno-72-12" name="__codelineno-72-12"></a>    <span class="p">)(</span><span class="n">tensor</span><span class="p">)</span>
<a id="__codelineno-72-13" name="__codelineno-72-13"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;block_</span><span class="si">{</span><span class="n">num_layer</span><span class="si">}</span><span class="s1">_bn_main&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-72-14" name="__codelineno-72-14"></a>
<a id="__codelineno-72-15" name="__codelineno-72-15"></a>    <span class="c1"># conv1x1 stream</span>
<a id="__codelineno-72-16" name="__codelineno-72-16"></a>
<a id="__codelineno-72-17" name="__codelineno-72-17"></a>    <span class="n">y</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span>
<a id="__codelineno-72-18" name="__codelineno-72-18"></a>        <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
<a id="__codelineno-72-19" name="__codelineno-72-19"></a>        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-72-20" name="__codelineno-72-20"></a>        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-72-21" name="__codelineno-72-21"></a>        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
<a id="__codelineno-72-22" name="__codelineno-72-22"></a>        <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_normal&quot;</span><span class="p">,</span>
<a id="__codelineno-72-23" name="__codelineno-72-23"></a>        <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-72-24" name="__codelineno-72-24"></a>        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;block_</span><span class="si">{</span><span class="n">num_layer</span><span class="si">}</span><span class="s1">_conv_alt&#39;</span>
<a id="__codelineno-72-25" name="__codelineno-72-25"></a>    <span class="p">)(</span><span class="n">tensor</span><span class="p">)</span>
<a id="__codelineno-72-26" name="__codelineno-72-26"></a>    <span class="n">y</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;block_</span><span class="si">{</span><span class="n">num_layer</span><span class="si">}</span><span class="s1">_bn_alt&#39;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-72-27" name="__codelineno-72-27"></a>
<a id="__codelineno-72-28" name="__codelineno-72-28"></a>    <span class="n">z</span> <span class="o">=</span> <span class="n">Add</span><span class="p">()([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">])</span>
<a id="__codelineno-72-29" name="__codelineno-72-29"></a>
<a id="__codelineno-72-30" name="__codelineno-72-30"></a>    <span class="k">return</span> <span class="n">z</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered celltag_function">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-73-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-73-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-73-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-73-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-73-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-73-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-73-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-73-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-73-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-73-10">10</a></span>
<span class="normal"><a href="#__codelineno-73-11">11</a></span>
<span class="normal"><a href="#__codelineno-73-12">12</a></span>
<span class="normal"><a href="#__codelineno-73-13">13</a></span>
<span class="normal"><a href="#__codelineno-73-14">14</a></span>
<span class="normal"><a href="#__codelineno-73-15">15</a></span>
<span class="normal"><a href="#__codelineno-73-16">16</a></span>
<span class="normal"><a href="#__codelineno-73-17">17</a></span>
<span class="normal"><a href="#__codelineno-73-18">18</a></span>
<span class="normal"><a href="#__codelineno-73-19">19</a></span>
<span class="normal"><a href="#__codelineno-73-20">20</a></span>
<span class="normal"><a href="#__codelineno-73-21">21</a></span>
<span class="normal"><a href="#__codelineno-73-22">22</a></span>
<span class="normal"><a href="#__codelineno-73-23">23</a></span>
<span class="normal"><a href="#__codelineno-73-24">24</a></span>
<span class="normal"><a href="#__codelineno-73-25">25</a></span>
<span class="normal"><a href="#__codelineno-73-26">26</a></span>
<span class="normal"><a href="#__codelineno-73-27">27</a></span>
<span class="normal"><a href="#__codelineno-73-28">28</a></span>
<span class="normal"><a href="#__codelineno-73-29">29</a></span>
<span class="normal"><a href="#__codelineno-73-30">30</a></span>
<span class="normal"><a href="#__codelineno-73-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1"></a><span class="k">def</span> <span class="nf">repvgg_block_with_id</span><span class="p">(</span><span class="n">tensor</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">num_layer</span><span class="p">):</span>
<a id="__codelineno-73-2" name="__codelineno-73-2"></a>
<a id="__codelineno-73-3" name="__codelineno-73-3"></a>    <span class="c1"># main stream</span>
<a id="__codelineno-73-4" name="__codelineno-73-4"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span>
<a id="__codelineno-73-5" name="__codelineno-73-5"></a>        <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
<a id="__codelineno-73-6" name="__codelineno-73-6"></a>        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
<a id="__codelineno-73-7" name="__codelineno-73-7"></a>        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-73-8" name="__codelineno-73-8"></a>        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
<a id="__codelineno-73-9" name="__codelineno-73-9"></a>        <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_normal&quot;</span><span class="p">,</span>
<a id="__codelineno-73-10" name="__codelineno-73-10"></a>        <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-73-11" name="__codelineno-73-11"></a>        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;block_</span><span class="si">{</span><span class="n">num_layer</span><span class="si">}</span><span class="s2">_conv_main&quot;</span><span class="p">,</span>
<a id="__codelineno-73-12" name="__codelineno-73-12"></a>    <span class="p">)(</span><span class="n">tensor</span><span class="p">)</span>
<a id="__codelineno-73-13" name="__codelineno-73-13"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;block_</span><span class="si">{</span><span class="n">num_layer</span><span class="si">}</span><span class="s2">_bn_main&quot;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-73-14" name="__codelineno-73-14"></a>
<a id="__codelineno-73-15" name="__codelineno-73-15"></a>    <span class="c1"># conv1x1 stream</span>
<a id="__codelineno-73-16" name="__codelineno-73-16"></a>
<a id="__codelineno-73-17" name="__codelineno-73-17"></a>    <span class="n">y</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span>
<a id="__codelineno-73-18" name="__codelineno-73-18"></a>        <span class="n">filters</span><span class="o">=</span><span class="n">filters</span><span class="p">,</span>
<a id="__codelineno-73-19" name="__codelineno-73-19"></a>        <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-73-20" name="__codelineno-73-20"></a>        <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-73-21" name="__codelineno-73-21"></a>        <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">,</span>
<a id="__codelineno-73-22" name="__codelineno-73-22"></a>        <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_normal&quot;</span><span class="p">,</span>
<a id="__codelineno-73-23" name="__codelineno-73-23"></a>        <span class="n">use_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-73-24" name="__codelineno-73-24"></a>        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;block_</span><span class="si">{</span><span class="n">num_layer</span><span class="si">}</span><span class="s2">_conv_alt&quot;</span><span class="p">,</span>
<a id="__codelineno-73-25" name="__codelineno-73-25"></a>    <span class="p">)(</span><span class="n">tensor</span><span class="p">)</span>
<a id="__codelineno-73-26" name="__codelineno-73-26"></a>    <span class="n">y</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;block_</span><span class="si">{</span><span class="n">num_layer</span><span class="si">}</span><span class="s2">_bn_alt&quot;</span><span class="p">)(</span><span class="n">y</span><span class="p">)</span>
<a id="__codelineno-73-27" name="__codelineno-73-27"></a>
<a id="__codelineno-73-28" name="__codelineno-73-28"></a>    <span class="c1"># id_conv branch</span>
<a id="__codelineno-73-29" name="__codelineno-73-29"></a>    <span class="n">z</span> <span class="o">=</span> <span class="n">BatchNormalization</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;block_</span><span class="si">{</span><span class="n">num_layer</span><span class="si">}</span><span class="s2">_bn_id&quot;</span><span class="p">)(</span><span class="n">tensor</span><span class="p">)</span>
<a id="__codelineno-73-30" name="__codelineno-73-30"></a>
<a id="__codelineno-73-31" name="__codelineno-73-31"></a>    <span class="k">return</span> <span class="n">Add</span><span class="p">()([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered celltag_function">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-74-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-74-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-74-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-74-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-74-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-74-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-74-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-74-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-74-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-74-10">10</a></span>
<span class="normal"><a href="#__codelineno-74-11">11</a></span>
<span class="normal"><a href="#__codelineno-74-12">12</a></span>
<span class="normal"><a href="#__codelineno-74-13">13</a></span>
<span class="normal"><a href="#__codelineno-74-14">14</a></span>
<span class="normal"><a href="#__codelineno-74-15">15</a></span>
<span class="normal"><a href="#__codelineno-74-16">16</a></span>
<span class="normal"><a href="#__codelineno-74-17">17</a></span>
<span class="normal"><a href="#__codelineno-74-18">18</a></span>
<span class="normal"><a href="#__codelineno-74-19">19</a></span>
<span class="normal"><a href="#__codelineno-74-20">20</a></span>
<span class="normal"><a href="#__codelineno-74-21">21</a></span>
<span class="normal"><a href="#__codelineno-74-22">22</a></span>
<span class="normal"><a href="#__codelineno-74-23">23</a></span>
<span class="normal"><a href="#__codelineno-74-24">24</a></span>
<span class="normal"><a href="#__codelineno-74-25">25</a></span>
<span class="normal"><a href="#__codelineno-74-26">26</a></span>
<span class="normal"><a href="#__codelineno-74-27">27</a></span>
<span class="normal"><a href="#__codelineno-74-28">28</a></span>
<span class="normal"><a href="#__codelineno-74-29">29</a></span>
<span class="normal"><a href="#__codelineno-74-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1"></a><span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="n">img_shape</span><span class="p">):</span>
<a id="__codelineno-74-2" name="__codelineno-74-2"></a>
<a id="__codelineno-74-3" name="__codelineno-74-3"></a>    <span class="nb">input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">img_shape</span><span class="p">)</span>
<a id="__codelineno-74-4" name="__codelineno-74-4"></a>
<a id="__codelineno-74-5" name="__codelineno-74-5"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">repvgg_block</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">num_layer</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-74-6" name="__codelineno-74-6"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-7" name="__codelineno-74-7"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">repvgg_block</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">num_layer</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-74-8" name="__codelineno-74-8"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-9" name="__codelineno-74-9"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">repvgg_block_with_id</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">num_layer</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-74-10" name="__codelineno-74-10"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-11" name="__codelineno-74-11"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">Flatten</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-12" name="__codelineno-74-12"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-13" name="__codelineno-74-13"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">Softmax</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-14" name="__codelineno-74-14"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-15" name="__codelineno-74-15"></a>    <span class="k">return</span> <span class="n">model</span>
<a id="__codelineno-74-16" name="__codelineno-74-16"></a>
<a id="__codelineno-74-17" name="__codelineno-74-17"></a><span class="k">def</span> <span class="nf">get_inference_model</span><span class="p">(</span><span class="n">img_shape</span><span class="p">):</span>
<a id="__codelineno-74-18" name="__codelineno-74-18"></a>    <span class="nb">input</span> <span class="o">=</span> <span class="n">Input</span><span class="p">(</span><span class="n">img_shape</span><span class="p">)</span>
<a id="__codelineno-74-19" name="__codelineno-74-19"></a>
<a id="__codelineno-74-20" name="__codelineno-74-20"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_0&#39;</span><span class="p">)(</span><span class="nb">input</span><span class="p">)</span>
<a id="__codelineno-74-21" name="__codelineno-74-21"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-22" name="__codelineno-74-22"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_1&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-23" name="__codelineno-74-23"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-24" name="__codelineno-74-24"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;conv_2&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-25" name="__codelineno-74-25"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">ReLU</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-26" name="__codelineno-74-26"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">Flatten</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-27" name="__codelineno-74-27"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dense&#39;</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-28" name="__codelineno-74-28"></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">Softmax</span><span class="p">()(</span><span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-29" name="__codelineno-74-29"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<a id="__codelineno-74-30" name="__codelineno-74-30"></a>    <span class="k">return</span> <span class="n">model</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-75-1">1</a></span>
<span class="normal"><a href="#__codelineno-75-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1"></a><span class="n">training_model</span> <span class="o">=</span> <span class="n">get_model</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-75-2" name="__codelineno-75-2"></a><span class="n">training_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Model: &#34;model_11&#34;
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_14 (InputLayer)           [(None, 32, 32, 3)]  0                                            
__________________________________________________________________________________________________
block_0_conv_main (Conv2D)      (None, 16, 16, 64)   1728        input_14[0][0]                   
__________________________________________________________________________________________________
block_0_conv_alt (Conv2D)       (None, 16, 16, 64)   192         input_14[0][0]                   
__________________________________________________________________________________________________
block_0_bn_main (BatchNormaliza (None, 16, 16, 64)   256         block_0_conv_main[0][0]          
__________________________________________________________________________________________________
block_0_bn_alt (BatchNormalizat (None, 16, 16, 64)   256         block_0_conv_alt[0][0]           
__________________________________________________________________________________________________
add_13 (Add)                    (None, 16, 16, 64)   0           block_0_bn_main[0][0]            
                                                                 block_0_bn_alt[0][0]             
__________________________________________________________________________________________________
re_lu_20 (ReLU)                 (None, 16, 16, 64)   0           add_13[0][0]                     
__________________________________________________________________________________________________
block_1_conv_main (Conv2D)      (None, 8, 8, 64)     36864       re_lu_20[0][0]                   
__________________________________________________________________________________________________
block_1_conv_alt (Conv2D)       (None, 8, 8, 64)     4096        re_lu_20[0][0]                   
__________________________________________________________________________________________________
block_1_bn_main (BatchNormaliza (None, 8, 8, 64)     256         block_1_conv_main[0][0]          
__________________________________________________________________________________________________
block_1_bn_alt (BatchNormalizat (None, 8, 8, 64)     256         block_1_conv_alt[0][0]           
__________________________________________________________________________________________________
add_14 (Add)                    (None, 8, 8, 64)     0           block_1_bn_main[0][0]            
                                                                 block_1_bn_alt[0][0]             
__________________________________________________________________________________________________
re_lu_21 (ReLU)                 (None, 8, 8, 64)     0           add_14[0][0]                     
__________________________________________________________________________________________________
block_2_conv_main (Conv2D)      (None, 8, 8, 64)     36864       re_lu_21[0][0]                   
__________________________________________________________________________________________________
block_2_conv_alt (Conv2D)       (None, 8, 8, 64)     4096        re_lu_21[0][0]                   
__________________________________________________________________________________________________
block_2_bn_main (BatchNormaliza (None, 8, 8, 64)     256         block_2_conv_main[0][0]          
__________________________________________________________________________________________________
block_2_bn_alt (BatchNormalizat (None, 8, 8, 64)     256         block_2_conv_alt[0][0]           
__________________________________________________________________________________________________
block_2_bn_id (BatchNormalizati (None, 8, 8, 64)     256         re_lu_21[0][0]                   
__________________________________________________________________________________________________
add_15 (Add)                    (None, 8, 8, 64)     0           block_2_bn_main[0][0]            
                                                                 block_2_bn_alt[0][0]             
                                                                 block_2_bn_id[0][0]              
__________________________________________________________________________________________________
re_lu_22 (ReLU)                 (None, 8, 8, 64)     0           add_15[0][0]                     
__________________________________________________________________________________________________
flatten_6 (Flatten)             (None, 4096)         0           re_lu_22[0][0]                   
__________________________________________________________________________________________________
dense (Dense)                   (None, 10)           40970       flatten_6[0][0]                  
__________________________________________________________________________________________________
softmax_6 (Softmax)             (None, 10)           0           dense[0][0]                      
==================================================================================================
Total params: 126,602
Trainable params: 125,706
Non-trainable params: 896
__________________________________________________________________________________________________
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-76-1">1</a></span>
<span class="normal"><a href="#__codelineno-76-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1"></a><span class="n">inference_model</span> <span class="o">=</span> <span class="n">get_inference_model</span><span class="p">([</span><span class="mi">32</span><span class="p">,</span><span class="mi">32</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<a id="__codelineno-76-2" name="__codelineno-76-2"></a><span class="n">inference_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Model: &#34;model_12&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_15 (InputLayer)        [(None, 32, 32, 3)]       0         
_________________________________________________________________
conv_0 (Conv2D)              (None, 16, 16, 64)        1792      
_________________________________________________________________
re_lu_23 (ReLU)              (None, 16, 16, 64)        0         
_________________________________________________________________
conv_1 (Conv2D)              (None, 8, 8, 64)          36928     
_________________________________________________________________
re_lu_24 (ReLU)              (None, 8, 8, 64)          0         
_________________________________________________________________
conv_2 (Conv2D)              (None, 8, 8, 64)          36928     
_________________________________________________________________
re_lu_25 (ReLU)              (None, 8, 8, 64)          0         
_________________________________________________________________
flatten_7 (Flatten)          (None, 4096)              0         
_________________________________________________________________
dense (Dense)                (None, 10)                40970     
_________________________________________________________________
softmax_7 (Softmax)          (None, 10)                0         
=================================================================
Total params: 116,618
Trainable params: 116,618
Non-trainable params: 0
_________________________________________________________________
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered celltag_function">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-77-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-77-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-77-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-77-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-77-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-77-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-77-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-77-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-77-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-77-10">10</a></span>
<span class="normal"><a href="#__codelineno-77-11">11</a></span>
<span class="normal"><a href="#__codelineno-77-12">12</a></span>
<span class="normal"><a href="#__codelineno-77-13">13</a></span>
<span class="normal"><a href="#__codelineno-77-14">14</a></span>
<span class="normal"><a href="#__codelineno-77-15">15</a></span>
<span class="normal"><a href="#__codelineno-77-16">16</a></span>
<span class="normal"><a href="#__codelineno-77-17">17</a></span>
<span class="normal"><a href="#__codelineno-77-18">18</a></span>
<span class="normal"><a href="#__codelineno-77-19">19</a></span>
<span class="normal"><a href="#__codelineno-77-20">20</a></span>
<span class="normal"><a href="#__codelineno-77-21">21</a></span>
<span class="normal"><a href="#__codelineno-77-22">22</a></span>
<span class="normal"><a href="#__codelineno-77-23">23</a></span>
<span class="normal"><a href="#__codelineno-77-24">24</a></span>
<span class="normal"><a href="#__codelineno-77-25">25</a></span>
<span class="normal"><a href="#__codelineno-77-26">26</a></span>
<span class="normal"><a href="#__codelineno-77-27">27</a></span>
<span class="normal"><a href="#__codelineno-77-28">28</a></span>
<span class="normal"><a href="#__codelineno-77-29">29</a></span>
<span class="normal"><a href="#__codelineno-77-30">30</a></span>
<span class="normal"><a href="#__codelineno-77-31">31</a></span>
<span class="normal"><a href="#__codelineno-77-32">32</a></span>
<span class="normal"><a href="#__codelineno-77-33">33</a></span>
<span class="normal"><a href="#__codelineno-77-34">34</a></span>
<span class="normal"><a href="#__codelineno-77-35">35</a></span>
<span class="normal"><a href="#__codelineno-77-36">36</a></span>
<span class="normal"><a href="#__codelineno-77-37">37</a></span>
<span class="normal"><a href="#__codelineno-77-38">38</a></span>
<span class="normal"><a href="#__codelineno-77-39">39</a></span>
<span class="normal"><a href="#__codelineno-77-40">40</a></span>
<span class="normal"><a href="#__codelineno-77-41">41</a></span>
<span class="normal"><a href="#__codelineno-77-42">42</a></span>
<span class="normal"><a href="#__codelineno-77-43">43</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1"></a><span class="k">def</span> <span class="nf">from_repvgg_to_vgg</span><span class="p">(</span><span class="n">training_model</span><span class="p">,</span> <span class="n">inference_model</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
<a id="__codelineno-77-2" name="__codelineno-77-2"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">training_model</span>
<a id="__codelineno-77-3" name="__codelineno-77-3"></a>    <span class="n">inference_model</span> <span class="o">=</span> <span class="n">inference_model</span>
<a id="__codelineno-77-4" name="__codelineno-77-4"></a>
<a id="__codelineno-77-5" name="__codelineno-77-5"></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
<a id="__codelineno-77-6" name="__codelineno-77-6"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fusion Conv-BN from main branch at depth </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-77-7" name="__codelineno-77-7"></a>        <span class="n">conv_main</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;block_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_conv_main&quot;</span><span class="p">)</span>
<a id="__codelineno-77-8" name="__codelineno-77-8"></a>        <span class="n">bn_main</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;block_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_bn_main&quot;</span><span class="p">)</span>
<a id="__codelineno-77-9" name="__codelineno-77-9"></a>
<a id="__codelineno-77-10" name="__codelineno-77-10"></a>        <span class="n">conv_weights_main</span><span class="p">,</span> <span class="n">conv_biases_main</span> <span class="o">=</span> <span class="n">fuse_bn_conv</span><span class="p">(</span>
<a id="__codelineno-77-11" name="__codelineno-77-11"></a>            <span class="n">conv_main</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(),</span> <span class="n">bn_main</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
<a id="__codelineno-77-12" name="__codelineno-77-12"></a>        <span class="p">)</span>
<a id="__codelineno-77-13" name="__codelineno-77-13"></a>
<a id="__codelineno-77-14" name="__codelineno-77-14"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fusion Conv-BN from alt branch at depth </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-77-15" name="__codelineno-77-15"></a>        <span class="n">conv_alt_one_by_one</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;block_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_conv_alt&quot;</span><span class="p">)</span>
<a id="__codelineno-77-16" name="__codelineno-77-16"></a>        <span class="n">bn_alt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;block_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_bn_alt&quot;</span><span class="p">)</span>
<a id="__codelineno-77-17" name="__codelineno-77-17"></a>
<a id="__codelineno-77-18" name="__codelineno-77-18"></a>        <span class="n">conv_alt</span> <span class="o">=</span> <span class="n">pad_size_one_kernel</span><span class="p">(</span><span class="n">conv_alt_one_by_one</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
<a id="__codelineno-77-19" name="__codelineno-77-19"></a>
<a id="__codelineno-77-20" name="__codelineno-77-20"></a>        <span class="n">conv_weights_alt</span><span class="p">,</span> <span class="n">conv_biases_alt</span> <span class="o">=</span> <span class="n">fuse_bn_conv</span><span class="p">([</span><span class="n">conv_alt</span><span class="p">],</span> <span class="n">bn_alt</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
<a id="__codelineno-77-21" name="__codelineno-77-21"></a>
<a id="__codelineno-77-22" name="__codelineno-77-22"></a>        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>
<a id="__codelineno-77-23" name="__codelineno-77-23"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fusion Conv-BN from id branch at depth </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-77-24" name="__codelineno-77-24"></a>            <span class="n">bn_id</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;block_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_bn_id&quot;</span><span class="p">)</span>
<a id="__codelineno-77-25" name="__codelineno-77-25"></a>            <span class="n">channels</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">int_shape</span><span class="p">(</span><span class="n">bn_id</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()[</span><span class="mi">0</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-77-26" name="__codelineno-77-26"></a>
<a id="__codelineno-77-27" name="__codelineno-77-27"></a>            <span class="n">conv_id</span> <span class="o">=</span> <span class="n">size_three_kernel_from_id</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>
<a id="__codelineno-77-28" name="__codelineno-77-28"></a>            <span class="n">conv_weights_id</span><span class="p">,</span> <span class="n">conv_biases_id</span> <span class="o">=</span> <span class="n">fuse_bn_conv</span><span class="p">([</span><span class="n">conv_id</span><span class="p">],</span> <span class="n">bn_id</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span>
<a id="__codelineno-77-29" name="__codelineno-77-29"></a>
<a id="__codelineno-77-30" name="__codelineno-77-30"></a>            <span class="n">conv_weights</span> <span class="o">=</span> <span class="n">conv_weights_main</span> <span class="o">+</span> <span class="n">conv_weights_alt</span> <span class="o">+</span> <span class="n">conv_weights_id</span>
<a id="__codelineno-77-31" name="__codelineno-77-31"></a>            <span class="n">conv_biases</span> <span class="o">=</span> <span class="n">conv_biases_main</span> <span class="o">+</span> <span class="n">conv_biases_alt</span> <span class="o">+</span> <span class="n">conv_biases_id</span>
<a id="__codelineno-77-32" name="__codelineno-77-32"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-77-33" name="__codelineno-77-33"></a>            <span class="n">conv_weights</span> <span class="o">=</span> <span class="n">conv_weights_main</span> <span class="o">+</span> <span class="n">conv_weights_alt</span>
<a id="__codelineno-77-34" name="__codelineno-77-34"></a>            <span class="n">conv_biases</span> <span class="o">=</span> <span class="n">conv_biases_main</span> <span class="o">+</span> <span class="n">conv_biases_alt</span>
<a id="__codelineno-77-35" name="__codelineno-77-35"></a>
<a id="__codelineno-77-36" name="__codelineno-77-36"></a>
<a id="__codelineno-77-37" name="__codelineno-77-37"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting weights on inference model at depth </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-77-38" name="__codelineno-77-38"></a>        <span class="n">inference_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;conv_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_weights</span><span class="p">([</span><span class="n">conv_weights</span><span class="p">,</span> <span class="n">conv_biases</span><span class="p">])</span>
<a id="__codelineno-77-39" name="__codelineno-77-39"></a>
<a id="__codelineno-77-40" name="__codelineno-77-40"></a>    <span class="n">dense_weights</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dense&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
<a id="__codelineno-77-41" name="__codelineno-77-41"></a>    <span class="n">inference_model</span><span class="o">.</span><span class="n">get_layer</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dense&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">dense_weights</span><span class="p">)</span>
<a id="__codelineno-77-42" name="__codelineno-77-42"></a>
<a id="__codelineno-77-43" name="__codelineno-77-43"></a>    <span class="k">return</span> <span class="n">inference_model</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-78-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-78-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-78-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-78-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-78-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-78-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-78-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-78-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-78-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-78-10">10</a></span>
<span class="normal"><a href="#__codelineno-78-11">11</a></span>
<span class="normal"><a href="#__codelineno-78-12">12</a></span>
<span class="normal"><a href="#__codelineno-78-13">13</a></span>
<span class="normal"><a href="#__codelineno-78-14">14</a></span>
<span class="normal"><a href="#__codelineno-78-15">15</a></span>
<span class="normal"><a href="#__codelineno-78-16">16</a></span>
<span class="normal"><a href="#__codelineno-78-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1"></a><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">datasets</span>
<a id="__codelineno-78-2" name="__codelineno-78-2"></a><span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<a id="__codelineno-78-3" name="__codelineno-78-3"></a>
<a id="__codelineno-78-4" name="__codelineno-78-4"></a><span class="p">(</span><span class="n">X_train</span><span class="p">,</span><span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span><span class="n">y_test</span><span class="p">)</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">cifar10</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
<a id="__codelineno-78-5" name="__codelineno-78-5"></a>
<a id="__codelineno-78-6" name="__codelineno-78-6"></a><span class="c1"># Normalize pixel values to be between 0 and 1</span>
<a id="__codelineno-78-7" name="__codelineno-78-7"></a><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_train</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">/</span> <span class="mf">255.0</span>
<a id="__codelineno-78-8" name="__codelineno-78-8"></a>
<a id="__codelineno-78-9" name="__codelineno-78-9"></a><span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<a id="__codelineno-78-10" name="__codelineno-78-10"></a><span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
<a id="__codelineno-78-11" name="__codelineno-78-11"></a>
<a id="__codelineno-78-12" name="__codelineno-78-12"></a>
<a id="__codelineno-78-13" name="__codelineno-78-13"></a><span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<a id="__codelineno-78-14" name="__codelineno-78-14"></a>
<a id="__codelineno-78-15" name="__codelineno-78-15"></a><span class="n">y_train_oh</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-78-16" name="__codelineno-78-16"></a><span class="n">y_test_oh</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-78-17" name="__codelineno-78-17"></a><span class="n">y_valid_oh</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">to_categorical</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-79-1">1</a></span>
<span class="normal"><a href="#__codelineno-79-2">2</a></span>
<span class="normal"><a href="#__codelineno-79-3">3</a></span>
<span class="normal"><a href="#__codelineno-79-4">4</a></span>
<span class="normal"><a href="#__codelineno-79-5">5</a></span>
<span class="normal"><a href="#__codelineno-79-6">6</a></span>
<span class="normal"><a href="#__codelineno-79-7">7</a></span>
<span class="normal"><a href="#__codelineno-79-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1"></a><span class="n">training_model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
<a id="__codelineno-79-2" name="__codelineno-79-2"></a>             <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span>
<a id="__codelineno-79-3" name="__codelineno-79-3"></a>             <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<a id="__codelineno-79-4" name="__codelineno-79-4"></a>
<a id="__codelineno-79-5" name="__codelineno-79-5"></a><span class="n">training_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train_oh</span><span class="p">,</span>
<a id="__codelineno-79-6" name="__codelineno-79-6"></a>                     <span class="n">epochs</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
<a id="__codelineno-79-7" name="__codelineno-79-7"></a>                     <span class="n">batch_size</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
<a id="__codelineno-79-8" name="__codelineno-79-8"></a>                     <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid</span><span class="p">,</span> <span class="n">y_valid_oh</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Epoch 1/200
293/293 [==============================] - 2s 4ms/step - loss: 1.9390 - accuracy: 0.3690 - val_loss: 1.4326 - val_accuracy: 0.4882
Epoch 2/200
293/293 [==============================] - 1s 3ms/step - loss: 1.1761 - accuracy: 0.5805 - val_loss: 1.2776 - val_accuracy: 0.5559
Epoch 3/200
293/293 [==============================] - 1s 3ms/step - loss: 0.9771 - accuracy: 0.6608 - val_loss: 1.2784 - val_accuracy: 0.5692
Epoch 4/200
293/293 [==============================] - 1s 3ms/step - loss: 0.8457 - accuracy: 0.7047 - val_loss: 1.1538 - val_accuracy: 0.6070
Epoch 5/200
293/293 [==============================] - 1s 3ms/step - loss: 0.7411 - accuracy: 0.7415 - val_loss: 1.1523 - val_accuracy: 0.6082
Epoch 6/200
293/293 [==============================] - 1s 3ms/step - loss: 0.6627 - accuracy: 0.7721 - val_loss: 1.2050 - val_accuracy: 0.6056
Epoch 7/200
293/293 [==============================] - 1s 3ms/step - loss: 0.5730 - accuracy: 0.8017 - val_loss: 1.3360 - val_accuracy: 0.5908
Epoch 8/200
293/293 [==============================] - 1s 4ms/step - loss: 0.5037 - accuracy: 0.8267 - val_loss: 1.2697 - val_accuracy: 0.6086
Epoch 9/200
293/293 [==============================] - 1s 4ms/step - loss: 0.4315 - accuracy: 0.8549 - val_loss: 1.6375 - val_accuracy: 0.5710
Epoch 10/200
293/293 [==============================] - 1s 3ms/step - loss: 0.3744 - accuracy: 0.8732 - val_loss: 1.4501 - val_accuracy: 0.6078
Epoch 11/200
293/293 [==============================] - 1s 4ms/step - loss: 0.3140 - accuracy: 0.8947 - val_loss: 1.3964 - val_accuracy: 0.6189
Epoch 12/200
293/293 [==============================] - 1s 4ms/step - loss: 0.2657 - accuracy: 0.9140 - val_loss: 1.4346 - val_accuracy: 0.6252
Epoch 13/200
293/293 [==============================] - 1s 3ms/step - loss: 0.2328 - accuracy: 0.9247 - val_loss: 1.7435 - val_accuracy: 0.6030
Epoch 14/200
293/293 [==============================] - 1s 3ms/step - loss: 0.1914 - accuracy: 0.9402 - val_loss: 1.6220 - val_accuracy: 0.6197
Epoch 15/200
293/293 [==============================] - 1s 4ms/step - loss: 0.1661 - accuracy: 0.9486 - val_loss: 2.0838 - val_accuracy: 0.5826
Epoch 16/200
293/293 [==============================] - 1s 3ms/step - loss: 0.1485 - accuracy: 0.9539 - val_loss: 1.6913 - val_accuracy: 0.6221
Epoch 17/200
293/293 [==============================] - 1s 4ms/step - loss: 0.1283 - accuracy: 0.9603 - val_loss: 1.7873 - val_accuracy: 0.6273
Epoch 18/200
293/293 [==============================] - 1s 3ms/step - loss: 0.1113 - accuracy: 0.9667 - val_loss: 1.9872 - val_accuracy: 0.6094
Epoch 19/200
293/293 [==============================] - 1s 4ms/step - loss: 0.1026 - accuracy: 0.9691 - val_loss: 2.0423 - val_accuracy: 0.6062
Epoch 20/200
293/293 [==============================] - 1s 4ms/step - loss: 0.1021 - accuracy: 0.9666 - val_loss: 2.0206 - val_accuracy: 0.6166
Epoch 21/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0920 - accuracy: 0.9714 - val_loss: 2.0964 - val_accuracy: 0.6199
Epoch 22/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0794 - accuracy: 0.9750 - val_loss: 2.4125 - val_accuracy: 0.5951
Epoch 23/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0647 - accuracy: 0.9814 - val_loss: 2.2896 - val_accuracy: 0.6095
Epoch 24/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0907 - accuracy: 0.9686 - val_loss: 2.3337 - val_accuracy: 0.6104
Epoch 25/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0774 - accuracy: 0.9755 - val_loss: 2.7223 - val_accuracy: 0.5977
Epoch 26/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0615 - accuracy: 0.9804 - val_loss: 2.3225 - val_accuracy: 0.6226
Epoch 27/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0616 - accuracy: 0.9815 - val_loss: 2.3531 - val_accuracy: 0.6187
Epoch 28/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0510 - accuracy: 0.9862 - val_loss: 2.5024 - val_accuracy: 0.6199
Epoch 29/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0528 - accuracy: 0.9838 - val_loss: 2.9272 - val_accuracy: 0.5823
Epoch 30/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0715 - accuracy: 0.9745 - val_loss: 2.4670 - val_accuracy: 0.6142
Epoch 31/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0780 - accuracy: 0.9733 - val_loss: 2.6590 - val_accuracy: 0.6194
Epoch 32/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0636 - accuracy: 0.9776 - val_loss: 2.5846 - val_accuracy: 0.6173
Epoch 33/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0364 - accuracy: 0.9898 - val_loss: 2.5448 - val_accuracy: 0.6227
Epoch 34/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0308 - accuracy: 0.9915 - val_loss: 2.6284 - val_accuracy: 0.6238
Epoch 35/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0307 - accuracy: 0.9914 - val_loss: 2.8331 - val_accuracy: 0.6170
Epoch 36/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0561 - accuracy: 0.9809 - val_loss: 3.3461 - val_accuracy: 0.5866
Epoch 37/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0740 - accuracy: 0.9740 - val_loss: 2.9504 - val_accuracy: 0.6025
Epoch 38/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0706 - accuracy: 0.9749 - val_loss: 2.7457 - val_accuracy: 0.6227
Epoch 39/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0456 - accuracy: 0.9849 - val_loss: 2.7979 - val_accuracy: 0.6226
Epoch 40/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0269 - accuracy: 0.9929 - val_loss: 2.8238 - val_accuracy: 0.6207
Epoch 41/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0178 - accuracy: 0.9957 - val_loss: 2.8020 - val_accuracy: 0.6298
Epoch 42/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0161 - accuracy: 0.9959 - val_loss: 2.8443 - val_accuracy: 0.6261
Epoch 43/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0377 - accuracy: 0.9870 - val_loss: 4.3773 - val_accuracy: 0.5440
Epoch 44/200
293/293 [==============================] - 1s 4ms/step - loss: 0.1039 - accuracy: 0.9646 - val_loss: 3.0375 - val_accuracy: 0.6030
Epoch 45/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0617 - accuracy: 0.9799 - val_loss: 2.8326 - val_accuracy: 0.6314
Epoch 46/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0328 - accuracy: 0.9899 - val_loss: 2.8987 - val_accuracy: 0.6274
Epoch 47/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0190 - accuracy: 0.9945 - val_loss: 2.9066 - val_accuracy: 0.6258
Epoch 48/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0134 - accuracy: 0.9962 - val_loss: 3.0005 - val_accuracy: 0.6267
Epoch 49/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0098 - accuracy: 0.9980 - val_loss: 2.9672 - val_accuracy: 0.6337
Epoch 50/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0150 - accuracy: 0.9957 - val_loss: 3.4715 - val_accuracy: 0.5854
Epoch 51/200
293/293 [==============================] - 1s 4ms/step - loss: 0.1082 - accuracy: 0.9634 - val_loss: 3.1194 - val_accuracy: 0.6069
Epoch 52/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0703 - accuracy: 0.9746 - val_loss: 3.4825 - val_accuracy: 0.6022
Epoch 53/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0372 - accuracy: 0.9875 - val_loss: 3.1542 - val_accuracy: 0.6277
Epoch 54/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0176 - accuracy: 0.9953 - val_loss: 3.0385 - val_accuracy: 0.6305
Epoch 55/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0099 - accuracy: 0.9978 - val_loss: 3.0361 - val_accuracy: 0.6351
Epoch 56/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0067 - accuracy: 0.9987 - val_loss: 3.0368 - val_accuracy: 0.6361
Epoch 57/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0042 - accuracy: 0.9995 - val_loss: 3.1196 - val_accuracy: 0.6257
Epoch 58/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0070 - accuracy: 0.9984 - val_loss: 3.2946 - val_accuracy: 0.6184
Epoch 59/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0844 - accuracy: 0.9726 - val_loss: 3.6981 - val_accuracy: 0.5838
Epoch 60/200
293/293 [==============================] - 1s 4ms/step - loss: 0.1068 - accuracy: 0.9615 - val_loss: 3.3662 - val_accuracy: 0.6150
Epoch 61/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0331 - accuracy: 0.9884 - val_loss: 3.1085 - val_accuracy: 0.6268
Epoch 62/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0139 - accuracy: 0.9960 - val_loss: 3.2636 - val_accuracy: 0.6290
Epoch 63/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0095 - accuracy: 0.9980 - val_loss: 3.1850 - val_accuracy: 0.6310
Epoch 64/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0063 - accuracy: 0.9987 - val_loss: 3.2820 - val_accuracy: 0.6345
Epoch 65/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0031 - accuracy: 0.9997 - val_loss: 3.1574 - val_accuracy: 0.6397
Epoch 66/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0017 - accuracy: 1.0000 - val_loss: 3.1854 - val_accuracy: 0.6414
Epoch 67/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0012 - accuracy: 1.0000 - val_loss: 3.1196 - val_accuracy: 0.6458
Epoch 68/200
293/293 [==============================] - 1s 4ms/step - loss: 9.6865e-04 - accuracy: 1.0000 - val_loss: 3.1958 - val_accuracy: 0.6469
Epoch 69/200
293/293 [==============================] - 1s 4ms/step - loss: 8.6404e-04 - accuracy: 1.0000 - val_loss: 3.1414 - val_accuracy: 0.6472
Epoch 70/200
293/293 [==============================] - 1s 4ms/step - loss: 5.8577e-04 - accuracy: 1.0000 - val_loss: 3.1648 - val_accuracy: 0.6446
Epoch 71/200
293/293 [==============================] - 1s 4ms/step - loss: 5.2701e-04 - accuracy: 1.0000 - val_loss: 3.2118 - val_accuracy: 0.6478
Epoch 72/200
293/293 [==============================] - 1s 4ms/step - loss: 0.1478 - accuracy: 0.9627 - val_loss: 3.3232 - val_accuracy: 0.5995
Epoch 73/200
293/293 [==============================] - 1s 4ms/step - loss: 0.1219 - accuracy: 0.9585 - val_loss: 3.0879 - val_accuracy: 0.6179
Epoch 74/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0325 - accuracy: 0.9888 - val_loss: 3.1610 - val_accuracy: 0.6290
Epoch 75/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0124 - accuracy: 0.9973 - val_loss: 3.0288 - val_accuracy: 0.6348
Epoch 76/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0045 - accuracy: 0.9997 - val_loss: 3.0254 - val_accuracy: 0.6465
Epoch 77/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0027 - accuracy: 0.9999 - val_loss: 3.0743 - val_accuracy: 0.6470
Epoch 78/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0019 - accuracy: 0.9999 - val_loss: 3.1198 - val_accuracy: 0.6430
Epoch 79/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0016 - accuracy: 1.0000 - val_loss: 3.0889 - val_accuracy: 0.6466
Epoch 80/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0013 - accuracy: 1.0000 - val_loss: 3.1780 - val_accuracy: 0.6393
Epoch 81/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0015 - accuracy: 1.0000 - val_loss: 3.1530 - val_accuracy: 0.6427
Epoch 82/200
293/293 [==============================] - 1s 4ms/step - loss: 9.9041e-04 - accuracy: 1.0000 - val_loss: 3.1667 - val_accuracy: 0.6454
Epoch 83/200
293/293 [==============================] - 1s 4ms/step - loss: 9.6558e-04 - accuracy: 1.0000 - val_loss: 3.1835 - val_accuracy: 0.6430
Epoch 84/200
293/293 [==============================] - 1s 4ms/step - loss: 0.1062 - accuracy: 0.9710 - val_loss: 4.0625 - val_accuracy: 0.5772
Epoch 85/200
293/293 [==============================] - 1s 4ms/step - loss: 0.1073 - accuracy: 0.9622 - val_loss: 3.1034 - val_accuracy: 0.6308
Epoch 86/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0338 - accuracy: 0.9883 - val_loss: 3.1997 - val_accuracy: 0.6258
Epoch 87/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0141 - accuracy: 0.9965 - val_loss: 3.2102 - val_accuracy: 0.6319
Epoch 88/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0064 - accuracy: 0.9991 - val_loss: 3.1613 - val_accuracy: 0.6379
Epoch 89/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0039 - accuracy: 0.9996 - val_loss: 3.2062 - val_accuracy: 0.6387
Epoch 90/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0022 - accuracy: 0.9999 - val_loss: 3.1607 - val_accuracy: 0.6414
Epoch 91/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0014 - accuracy: 1.0000 - val_loss: 3.1905 - val_accuracy: 0.6446
Epoch 92/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0012 - accuracy: 0.9999 - val_loss: 3.2038 - val_accuracy: 0.6442
Epoch 93/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0011 - accuracy: 0.9999 - val_loss: 3.2732 - val_accuracy: 0.6409
Epoch 94/200
293/293 [==============================] - 1s 4ms/step - loss: 7.5633e-04 - accuracy: 1.0000 - val_loss: 3.2499 - val_accuracy: 0.6442
Epoch 95/200
293/293 [==============================] - 1s 4ms/step - loss: 7.7323e-04 - accuracy: 1.0000 - val_loss: 3.2885 - val_accuracy: 0.6450
Epoch 96/200
293/293 [==============================] - 1s 4ms/step - loss: 9.9023e-04 - accuracy: 1.0000 - val_loss: 3.4087 - val_accuracy: 0.6306
Epoch 97/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0088 - accuracy: 0.9979 - val_loss: 5.3897 - val_accuracy: 0.5452
Epoch 98/200
293/293 [==============================] - 1s 4ms/step - loss: 0.3004 - accuracy: 0.9175 - val_loss: 3.8454 - val_accuracy: 0.5955
Epoch 99/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0424 - accuracy: 0.9852 - val_loss: 3.4719 - val_accuracy: 0.6225
Epoch 100/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0128 - accuracy: 0.9972 - val_loss: 3.4143 - val_accuracy: 0.6262
Epoch 101/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0070 - accuracy: 0.9984 - val_loss: 3.2489 - val_accuracy: 0.6374
Epoch 102/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0036 - accuracy: 0.9996 - val_loss: 3.2455 - val_accuracy: 0.6399
Epoch 103/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0019 - accuracy: 1.0000 - val_loss: 3.2159 - val_accuracy: 0.6434
Epoch 104/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0015 - accuracy: 1.0000 - val_loss: 3.2219 - val_accuracy: 0.6451
Epoch 105/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0011 - accuracy: 1.0000 - val_loss: 3.2600 - val_accuracy: 0.6425
Epoch 106/200
293/293 [==============================] - 1s 4ms/step - loss: 8.9068e-04 - accuracy: 1.0000 - val_loss: 3.2839 - val_accuracy: 0.6430
Epoch 107/200
293/293 [==============================] - 1s 3ms/step - loss: 8.8232e-04 - accuracy: 1.0000 - val_loss: 3.2854 - val_accuracy: 0.6457
Epoch 108/200
293/293 [==============================] - 1s 3ms/step - loss: 6.3356e-04 - accuracy: 1.0000 - val_loss: 3.3021 - val_accuracy: 0.6451
Epoch 109/200
293/293 [==============================] - 1s 3ms/step - loss: 6.9747e-04 - accuracy: 1.0000 - val_loss: 3.3147 - val_accuracy: 0.6457
Epoch 110/200
293/293 [==============================] - 1s 3ms/step - loss: 5.3339e-04 - accuracy: 1.0000 - val_loss: 3.3380 - val_accuracy: 0.6454
Epoch 111/200
293/293 [==============================] - 1s 4ms/step - loss: 4.3812e-04 - accuracy: 1.0000 - val_loss: 3.3765 - val_accuracy: 0.6447
Epoch 112/200
293/293 [==============================] - 1s 3ms/step - loss: 4.1380e-04 - accuracy: 1.0000 - val_loss: 3.3854 - val_accuracy: 0.6460
Epoch 113/200
293/293 [==============================] - 1s 3ms/step - loss: 4.5256e-04 - accuracy: 1.0000 - val_loss: 3.4450 - val_accuracy: 0.6454
Epoch 114/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0543 - accuracy: 0.9867 - val_loss: 3.9023 - val_accuracy: 0.5873
Epoch 115/200
293/293 [==============================] - 1s 3ms/step - loss: 0.1773 - accuracy: 0.9468 - val_loss: 3.3988 - val_accuracy: 0.6180
Epoch 116/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0298 - accuracy: 0.9901 - val_loss: 3.3156 - val_accuracy: 0.6344
Epoch 117/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0111 - accuracy: 0.9966 - val_loss: 3.2564 - val_accuracy: 0.6354
Epoch 118/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0056 - accuracy: 0.9991 - val_loss: 3.3034 - val_accuracy: 0.6414
Epoch 119/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0030 - accuracy: 0.9996 - val_loss: 3.3015 - val_accuracy: 0.6431
Epoch 120/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0021 - accuracy: 0.9999 - val_loss: 3.3338 - val_accuracy: 0.6422
Epoch 121/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0015 - accuracy: 1.0000 - val_loss: 3.3000 - val_accuracy: 0.6458
Epoch 122/200
293/293 [==============================] - 1s 3ms/step - loss: 9.2647e-04 - accuracy: 1.0000 - val_loss: 3.3178 - val_accuracy: 0.6457
Epoch 123/200
293/293 [==============================] - 1s 3ms/step - loss: 8.6534e-04 - accuracy: 1.0000 - val_loss: 3.3308 - val_accuracy: 0.6482
Epoch 124/200
293/293 [==============================] - 1s 3ms/step - loss: 6.3539e-04 - accuracy: 1.0000 - val_loss: 3.3759 - val_accuracy: 0.6479
Epoch 125/200
293/293 [==============================] - 1s 3ms/step - loss: 6.1540e-04 - accuracy: 1.0000 - val_loss: 3.3861 - val_accuracy: 0.6474
Epoch 126/200
293/293 [==============================] - 1s 3ms/step - loss: 5.1956e-04 - accuracy: 1.0000 - val_loss: 3.3955 - val_accuracy: 0.6460
Epoch 127/200
293/293 [==============================] - 1s 3ms/step - loss: 4.9951e-04 - accuracy: 1.0000 - val_loss: 3.5187 - val_accuracy: 0.6467
Epoch 128/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0084 - accuracy: 0.9978 - val_loss: 4.4000 - val_accuracy: 0.5709
Epoch 129/200
293/293 [==============================] - 1s 3ms/step - loss: 0.2555 - accuracy: 0.9294 - val_loss: 3.7346 - val_accuracy: 0.6086
Epoch 130/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0358 - accuracy: 0.9878 - val_loss: 3.4413 - val_accuracy: 0.6241
Epoch 131/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0122 - accuracy: 0.9971 - val_loss: 3.4731 - val_accuracy: 0.6366
Epoch 132/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0064 - accuracy: 0.9985 - val_loss: 3.3815 - val_accuracy: 0.6391
Epoch 133/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0040 - accuracy: 0.9993 - val_loss: 3.4015 - val_accuracy: 0.6413
Epoch 134/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0022 - accuracy: 0.9998 - val_loss: 3.4036 - val_accuracy: 0.6428
Epoch 135/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0015 - accuracy: 1.0000 - val_loss: 3.4494 - val_accuracy: 0.6402
Epoch 136/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0016 - accuracy: 0.9999 - val_loss: 3.4177 - val_accuracy: 0.6470
Epoch 137/200
293/293 [==============================] - 1s 4ms/step - loss: 8.6482e-04 - accuracy: 1.0000 - val_loss: 3.4614 - val_accuracy: 0.6452
Epoch 138/200
293/293 [==============================] - 1s 4ms/step - loss: 6.2557e-04 - accuracy: 1.0000 - val_loss: 3.4649 - val_accuracy: 0.6465
Epoch 139/200
293/293 [==============================] - 1s 4ms/step - loss: 6.4032e-04 - accuracy: 1.0000 - val_loss: 3.4694 - val_accuracy: 0.6444
Epoch 140/200
293/293 [==============================] - 1s 4ms/step - loss: 5.6854e-04 - accuracy: 1.0000 - val_loss: 3.5629 - val_accuracy: 0.6450
Epoch 141/200
293/293 [==============================] - 1s 4ms/step - loss: 5.7389e-04 - accuracy: 1.0000 - val_loss: 3.5976 - val_accuracy: 0.6391
Epoch 142/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0730 - accuracy: 0.9803 - val_loss: 3.6825 - val_accuracy: 0.6078
Epoch 143/200
293/293 [==============================] - 1s 4ms/step - loss: 0.1055 - accuracy: 0.9660 - val_loss: 3.4045 - val_accuracy: 0.6313
Epoch 144/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0229 - accuracy: 0.9920 - val_loss: 3.5080 - val_accuracy: 0.6366
Epoch 145/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0088 - accuracy: 0.9976 - val_loss: 3.4096 - val_accuracy: 0.6414
Epoch 146/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0040 - accuracy: 0.9994 - val_loss: 3.4737 - val_accuracy: 0.6436
Epoch 147/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0024 - accuracy: 0.9997 - val_loss: 3.5510 - val_accuracy: 0.6415
Epoch 148/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0017 - accuracy: 0.9998 - val_loss: 3.5113 - val_accuracy: 0.6454
Epoch 149/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0012 - accuracy: 1.0000 - val_loss: 3.4949 - val_accuracy: 0.6440
Epoch 150/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0013 - accuracy: 0.9999 - val_loss: 3.5232 - val_accuracy: 0.6479
Epoch 151/200
293/293 [==============================] - 1s 4ms/step - loss: 9.0308e-04 - accuracy: 1.0000 - val_loss: 3.5569 - val_accuracy: 0.6500
Epoch 152/200
293/293 [==============================] - 1s 4ms/step - loss: 6.7638e-04 - accuracy: 1.0000 - val_loss: 3.5668 - val_accuracy: 0.6485
Epoch 153/200
293/293 [==============================] - 1s 3ms/step - loss: 6.3473e-04 - accuracy: 1.0000 - val_loss: 3.5986 - val_accuracy: 0.6502
Epoch 154/200
293/293 [==============================] - 1s 3ms/step - loss: 4.5041e-04 - accuracy: 1.0000 - val_loss: 3.5845 - val_accuracy: 0.6482
Epoch 155/200
293/293 [==============================] - 1s 3ms/step - loss: 4.0400e-04 - accuracy: 1.0000 - val_loss: 3.6154 - val_accuracy: 0.6446
Epoch 156/200
293/293 [==============================] - 1s 3ms/step - loss: 6.3062e-04 - accuracy: 1.0000 - val_loss: 3.7590 - val_accuracy: 0.6394
Epoch 157/200
293/293 [==============================] - 1s 3ms/step - loss: 0.1702 - accuracy: 0.9545 - val_loss: 3.6780 - val_accuracy: 0.6218
Epoch 158/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0543 - accuracy: 0.9818 - val_loss: 3.5992 - val_accuracy: 0.6316
Epoch 159/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0184 - accuracy: 0.9940 - val_loss: 3.7416 - val_accuracy: 0.6269
Epoch 160/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0061 - accuracy: 0.9988 - val_loss: 3.5675 - val_accuracy: 0.6382
Epoch 161/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0031 - accuracy: 0.9994 - val_loss: 3.6239 - val_accuracy: 0.6394
Epoch 162/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0021 - accuracy: 0.9997 - val_loss: 3.5901 - val_accuracy: 0.6389
Epoch 163/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0018 - accuracy: 0.9998 - val_loss: 3.6193 - val_accuracy: 0.6441
Epoch 164/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0012 - accuracy: 0.9999 - val_loss: 3.6285 - val_accuracy: 0.6438
Epoch 165/200
293/293 [==============================] - 1s 3ms/step - loss: 7.3676e-04 - accuracy: 1.0000 - val_loss: 3.6237 - val_accuracy: 0.6454
Epoch 166/200
293/293 [==============================] - 1s 3ms/step - loss: 5.4252e-04 - accuracy: 1.0000 - val_loss: 3.6783 - val_accuracy: 0.6441
Epoch 167/200
293/293 [==============================] - 1s 4ms/step - loss: 5.7206e-04 - accuracy: 1.0000 - val_loss: 3.6587 - val_accuracy: 0.6457
Epoch 168/200
293/293 [==============================] - 1s 3ms/step - loss: 5.1652e-04 - accuracy: 1.0000 - val_loss: 3.6578 - val_accuracy: 0.6467
Epoch 169/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0366 - accuracy: 0.9905 - val_loss: 4.2009 - val_accuracy: 0.5858
Epoch 170/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0951 - accuracy: 0.9697 - val_loss: 3.5935 - val_accuracy: 0.6283
Epoch 171/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0229 - accuracy: 0.9921 - val_loss: 3.6487 - val_accuracy: 0.6332
Epoch 172/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0066 - accuracy: 0.9983 - val_loss: 3.8405 - val_accuracy: 0.6329
Epoch 173/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0045 - accuracy: 0.9989 - val_loss: 3.6509 - val_accuracy: 0.6421
Epoch 174/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0023 - accuracy: 0.9997 - val_loss: 3.6520 - val_accuracy: 0.6394
Epoch 175/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0012 - accuracy: 1.0000 - val_loss: 3.6577 - val_accuracy: 0.6406
Epoch 176/200
293/293 [==============================] - 1s 4ms/step - loss: 6.8113e-04 - accuracy: 1.0000 - val_loss: 3.6778 - val_accuracy: 0.6417
Epoch 177/200
293/293 [==============================] - 1s 4ms/step - loss: 8.0387e-04 - accuracy: 1.0000 - val_loss: 3.6704 - val_accuracy: 0.6414
Epoch 178/200
293/293 [==============================] - 1s 3ms/step - loss: 6.4948e-04 - accuracy: 1.0000 - val_loss: 3.7070 - val_accuracy: 0.6417
Epoch 179/200
293/293 [==============================] - 1s 4ms/step - loss: 4.2156e-04 - accuracy: 1.0000 - val_loss: 3.7131 - val_accuracy: 0.6404
Epoch 180/200
293/293 [==============================] - 1s 4ms/step - loss: 5.7091e-04 - accuracy: 1.0000 - val_loss: 3.8784 - val_accuracy: 0.6346
Epoch 181/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0651 - accuracy: 0.9804 - val_loss: 4.3902 - val_accuracy: 0.5985
Epoch 182/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0633 - accuracy: 0.9788 - val_loss: 4.0795 - val_accuracy: 0.6162
Epoch 183/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0194 - accuracy: 0.9931 - val_loss: 4.0404 - val_accuracy: 0.6267
Epoch 184/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0076 - accuracy: 0.9979 - val_loss: 3.7312 - val_accuracy: 0.6357
Epoch 185/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0032 - accuracy: 0.9993 - val_loss: 3.7239 - val_accuracy: 0.6436
Epoch 186/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0016 - accuracy: 0.9997 - val_loss: 3.7600 - val_accuracy: 0.6344
Epoch 187/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0017 - accuracy: 0.9998 - val_loss: 3.7408 - val_accuracy: 0.6391
Epoch 188/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0012 - accuracy: 0.9999 - val_loss: 3.8037 - val_accuracy: 0.6379
Epoch 189/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0016 - accuracy: 0.9998 - val_loss: 3.8553 - val_accuracy: 0.6378
Epoch 190/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0050 - accuracy: 0.9984 - val_loss: 4.3736 - val_accuracy: 0.6046
Epoch 191/200
293/293 [==============================] - 1s 3ms/step - loss: 0.0759 - accuracy: 0.9757 - val_loss: 4.1114 - val_accuracy: 0.6099
Epoch 192/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0357 - accuracy: 0.9879 - val_loss: 4.0255 - val_accuracy: 0.6281
Epoch 193/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0121 - accuracy: 0.9959 - val_loss: 3.9506 - val_accuracy: 0.6345
Epoch 194/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0050 - accuracy: 0.9989 - val_loss: 3.9339 - val_accuracy: 0.6302
Epoch 195/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0030 - accuracy: 0.9994 - val_loss: 3.8998 - val_accuracy: 0.6373
Epoch 196/200
293/293 [==============================] - 1s 4ms/step - loss: 0.0015 - accuracy: 0.9997 - val_loss: 3.8751 - val_accuracy: 0.6438
Epoch 197/200
293/293 [==============================] - 1s 4ms/step - loss: 9.7056e-04 - accuracy: 1.0000 - val_loss: 3.8705 - val_accuracy: 0.6424
Epoch 198/200
293/293 [==============================] - 1s 3ms/step - loss: 5.4642e-04 - accuracy: 1.0000 - val_loss: 3.8781 - val_accuracy: 0.6441
Epoch 199/200
293/293 [==============================] - 1s 4ms/step - loss: 5.2847e-04 - accuracy: 1.0000 - val_loss: 3.8988 - val_accuracy: 0.6422
Epoch 200/200
293/293 [==============================] - 1s 3ms/step - loss: 5.0220e-04 - accuracy: 1.0000 - val_loss: 3.9146 - val_accuracy: 0.6449
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>&lt;tensorflow.python.keras.callbacks.History at 0x7fc892648ca0&gt;</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-80-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1"></a><span class="n">training_model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test_oh</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>313/313 [==============================] - 0s 1ms/step - loss: 4.0375 - accuracy: 0.6408
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>[4.037524223327637, 0.6407999992370605]</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-81-1">1</a></span>
<span class="normal"><a href="#__codelineno-81-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1"></a><span class="n">model</span> <span class="o">=</span> <span class="n">from_repvgg_to_vgg</span><span class="p">(</span><span class="n">training_model</span><span class="p">,</span> <span class="n">inference_model</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-81-2" name="__codelineno-81-2"></a><span class="n">model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>Fusion Conv-BN from main branch at depth 0
Fusion Conv-BN from alt branch at depth 0
Setting weights on inference model at depth 0
Fusion Conv-BN from main branch at depth 1
Fusion Conv-BN from alt branch at depth 1
Setting weights on inference model at depth 1
Fusion Conv-BN from main branch at depth 2
Fusion Conv-BN from alt branch at depth 2
Setting weights on inference model at depth 2
Model: &#34;model_12&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #   
=================================================================
input_15 (InputLayer)        [(None, 32, 32, 3)]       0         
_________________________________________________________________
conv_0 (Conv2D)              (None, 16, 16, 64)        1792      
_________________________________________________________________
re_lu_23 (ReLU)              (None, 16, 16, 64)        0         
_________________________________________________________________
conv_1 (Conv2D)              (None, 8, 8, 64)          36928     
_________________________________________________________________
re_lu_24 (ReLU)              (None, 8, 8, 64)          0         
_________________________________________________________________
conv_2 (Conv2D)              (None, 8, 8, 64)          36928     
_________________________________________________________________
re_lu_25 (ReLU)              (None, 8, 8, 64)          0         
_________________________________________________________________
flatten_7 (Flatten)          (None, 4096)              0         
_________________________________________________________________
dense (Dense)                (None, 10)                40970     
_________________________________________________________________
softmax_7 (Softmax)          (None, 10)                0         
=================================================================
Total params: 116,618
Trainable params: 116,618
Non-trainable params: 0
_________________________________________________________________
</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-82-1">1</a></span>
<span class="normal"><a href="#__codelineno-82-2">2</a></span>
<span class="normal"><a href="#__codelineno-82-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1"></a><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span> <span class="o">=</span> <span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
<a id="__codelineno-82-2" name="__codelineno-82-2"></a>             <span class="n">optimizer</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">2e-9</span><span class="p">),</span>
<a id="__codelineno-82-3" name="__codelineno-82-3"></a>             <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>

</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-83-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1"></a><span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test_oh</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area">
<div class="output_subarea output_stream output_stdout output_text">
<pre>
<code>313/313 [==============================] - 0s 1ms/step - loss: 7.8139 - accuracy: 0.3986
</code>
</pre>
</div>
</div>
<div class="output_area">
<div class="output_text output_subarea output_execute_result">
<pre>
<code>[7.867744445800781, 0.39640000462532043]</code>
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-84-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1"></a>
</code></pre></div></td></tr></table></div>

</div>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Retour en haut de la page
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.tabs", "navigation.top", "navigation.tabs.sticky", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.12658920.min.js", "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.5cf534bf.min.js"></script>
      
        <script src="../../../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>