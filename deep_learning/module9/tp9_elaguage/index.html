
<!doctype html>
<html lang="fr" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Mathieu Klimczak">
      
      
      
        <link rel="prev" href="../module9/">
      
      
        <link rel="next" href="../tp9_tflite/">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.2">
    
    
      
        <title>Pratique, l'élagage - Arctic Vault</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.f56500e0.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CJetBrains+Mono+Medium:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"JetBrains Mono Medium"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../../stylesheets/mkdocsoad.css">
    
      <link rel="stylesheet" href="../../../css/ansi-colours.css">
    
      <link rel="stylesheet" href="../../../css/jupyter-cells.css">
    
      <link rel="stylesheet" href="../../../css/pandas-dataframe.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tp-module-9-optimisation-des-modeles-elagage" class="md-skip">
          Aller au contenu
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="En-tête">
    <a href="../../.." title="Arctic Vault" class="md-header__button md-logo" aria-label="Arctic Vault" data-md-component="logo">
      
  <img src="../../../images/noun_Robot_1955251.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Arctic Vault
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pratique, l'élagage
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Basculer en mode sombre"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Basculer en mode sombre" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="deep-orange"  aria-label="Basculer en mode clair"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Basculer en mode clair" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Rechercher" placeholder="Rechercher" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Effacer" aria-label="Effacer" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initialisation de la recherche
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Onglets" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Accueil
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../module1/Module1/" class="md-tabs__link md-tabs__link--active">
        Deep Learning
      </a>
    </li>
  

  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../mlops/docker/" class="md-tabs__link">
        MLOps
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../azure_ml/intro/" class="md-tabs__link">
        AzureML
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../devops/linux/" class="md-tabs__link">
        DevOps 101
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../az104/az-ad/" class="md-tabs__link">
        AZ-104
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../ide_vscode/conf/" class="md-tabs__link">
        Guidelines
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../lectures/gradient_centralization/" class="md-tabs__link">
        Lectures
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Arctic Vault" class="md-nav__button md-logo" aria-label="Arctic Vault" data-md-component="logo">
      
  <img src="../../../images/noun_Robot_1955251.svg" alt="logo">

    </a>
    Arctic Vault
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Accueil
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Deep Learning
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Deep Learning" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Deep Learning
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_1" type="checkbox" id="__nav_2_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_1">
          Introduction au deep learning, prise en main de Tensorflow et Keras
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Introduction au deep learning, prise en main de Tensorflow et Keras" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_1">
          <span class="md-nav__icon md-icon"></span>
          Introduction au deep learning, prise en main de Tensorflow et Keras
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module1/Module1/" class="md-nav__link">
        Théorie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module1/tp1/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_2">
          Les réseaux de neurones convolutifs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Les réseaux de neurones convolutifs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          Les réseaux de neurones convolutifs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module2/Module2/" class="md-nav__link">
        Théorie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module2/module2_annexe/" class="md-nav__link">
        Annexe
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module2/tp2/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_3">
          Preprocessing des données avec l'API tf.data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Preprocessing des données avec l'API tf.data" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Preprocessing des données avec l'API tf.data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module3/Module3/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_4" type="checkbox" id="__nav_2_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_4">
          Optimisation et régularisation des réseaux de neurones
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Optimisation et régularisation des réseaux de neurones" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_4">
          <span class="md-nav__icon md-icon"></span>
          Optimisation et régularisation des réseaux de neurones
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module4/Module4/" class="md-nav__link">
        Théorie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module4/Module4_2/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_5" type="checkbox" id="__nav_2_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_5">
          Personnaliser son réseau de neurones
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Personnaliser son réseau de neurones" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_5">
          <span class="md-nav__icon md-icon"></span>
          Personnaliser son réseau de neurones
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module5/Module5/" class="md-nav__link">
        Théorie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module5/Module5_2/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_6" type="checkbox" id="__nav_2_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_6">
          La segmentation d'images
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="La segmentation d'images" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_6">
          <span class="md-nav__icon md-icon"></span>
          La segmentation d'images
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module6/module6/" class="md-nav__link">
        Théorie
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module6/Module6_2/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_7" type="checkbox" id="__nav_2_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_7">
          Les modèles générateurs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Les modèles générateurs" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_7">
          <span class="md-nav__icon md-icon"></span>
          Les modèles générateurs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../module7/Module7_2/" class="md-nav__link">
        Pratique
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_8" type="checkbox" id="__nav_2_8" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2_8">
          Déployer son réseau de neurones sur de l'embarqué
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Déployer son réseau de neurones sur de l'embarqué" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_8">
          <span class="md-nav__icon md-icon"></span>
          Déployer son réseau de neurones sur de l'embarqué
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../module9/" class="md-nav__link">
        Théorie
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Pratique, l'élagage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Pratique, l'élagage
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#import-des-librairies-creation-du-dataset" class="md-nav__link">
    Import des librairies, création du dataset
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pruningelagage" class="md-nav__link">
    Pruning/Elagage
  </a>
  
    <nav class="md-nav" aria-label="Pruning/Elagage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#elagage-constant" class="md-nav__link">
    Elagage constant
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decroissance-polynomiale" class="md-nav__link">
    Décroissance polynomiale
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mise-en-place" class="md-nav__link">
    Mise en place
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../tp9_tflite/" class="md-nav__link">
        Pratique, TFLite
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Module9_TFTRT/" class="md-nav__link">
        Pratique, TFTRT
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../fusion/" class="md-nav__link">
        Annexe, RepVGG
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../bnn/" class="md-nav__link">
        Les BNN
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_9" type="checkbox" id="__nav_2_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2_9">
          Algèbre tensorielle
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Algèbre tensorielle" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_9">
          <span class="md-nav__icon md-icon"></span>
          Algèbre tensorielle
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/algebra/" class="md-nav__link">
        Les tenseurs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../algebra/attn/" class="md-nav__link">
        L'attention
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          MLOps
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="MLOps" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          MLOps
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/docker/" class="md-nav__link">
        Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/DVC/" class="md-nav__link">
        Data versioning
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/mlem/" class="md-nav__link">
        Model Registry
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/featurestore/" class="md-nav__link">
        Feature store
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/hydra/" class="md-nav__link">
        Hydra
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/monitoring/" class="md-nav__link">
        Monitoring
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/optuna/" class="md-nav__link">
        Optimisation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../mlops/image_fastapi/" class="md-nav__link">
        REST API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          AzureML
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="AzureML" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          AzureML
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/intro/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/lesson1/" class="md-nav__link">
        SDK Azure
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/lesson1_project/" class="md-nav__link">
        HyperDrive et AutoML
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/lesson2/" class="md-nav__link">
        Déployer un modèle
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/lesson3/" class="md-nav__link">
        Utilisation du modèle déployé
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/lesson4/" class="md-nav__link">
        Pipelines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/annex1/" class="md-nav__link">
        Azure et Traefik
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../azure_ml/annex2/" class="md-nav__link">
        Azure et Caddy
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          DevOps 101
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="DevOps 101" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          DevOps 101
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/linux/" class="md-nav__link">
        Linux Basics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/git/" class="md-nav__link">
        Git
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/shell/" class="md-nav__link">
        Shell scripts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/network/" class="md-nav__link">
        Networking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/applications/" class="md-nav__link">
        Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/web_server/" class="md-nav__link">
        Web Servers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/terminal/" class="md-nav__link">
        Terminal
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/tls_ssl/" class="md-nav__link">
        SSL et TLS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/docker/" class="md-nav__link">
        Docker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/kubernetes/" class="md-nav__link">
        Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/yaml/" class="md-nav__link">
        YAML
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/redis/" class="md-nav__link">
        Redis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/az_devops/" class="md-nav__link">
        AzDevOps pipelines
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../devops/terraform/" class="md-nav__link">
        Terraform
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          AZ-104
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="AZ-104" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          AZ-104
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../az104/az-ad/" class="md-nav__link">
        Managing Azure Active Directory
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../az104/sub_and_gov/" class="md-nav__link">
        Subscription and Governance
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Guidelines
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Guidelines" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Guidelines
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../ide_vscode/conf/" class="md-nav__link">
        IDE vscode
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_2" type="checkbox" id="__nav_7_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_2">
          Documentation
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Documentation" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_2">
          <span class="md-nav__icon md-icon"></span>
          Documentation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../doc_redaction/mkdocs/" class="md-nav__link">
        MkDocs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../doc_redaction/diagrammes/" class="md-nav__link">
        Diagrammes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_3" type="checkbox" id="__nav_7_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_3">
          Formating, Linting, Type Hinting
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Formating, Linting, Type Hinting" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_3">
          <span class="md-nav__icon md-icon"></span>
          Formating, Linting, Type Hinting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../format_lint_hint/format/" class="md-nav__link">
        Formating
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../format_lint_hint/lint/" class="md-nav__link">
        Linting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../format_lint_hint/hint/" class="md-nav__link">
        Hint
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_4" type="checkbox" id="__nav_7_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_4">
          Tests
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tests" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_4">
          <span class="md-nav__icon md-icon"></span>
          Tests
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../testing/unittests/" class="md-nav__link">
        Test unitaire
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_5" type="checkbox" id="__nav_7_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_5">
          CI/CD
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="CI/CD" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_5">
          <span class="md-nav__icon md-icon"></span>
          CI/CD
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../cicd/precommit/" class="md-nav__link">
        Pre-commit
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_6" type="checkbox" id="__nav_7_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_6">
          Code quality
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Code quality" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_6">
          <span class="md-nav__icon md-icon"></span>
          Code quality
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../code_quality/radon/" class="md-nav__link">
        Radon
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7_7" type="checkbox" id="__nav_7_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7_7">
          Code security
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Code security" data-md-level="2">
        <label class="md-nav__title" for="__nav_7_7">
          <span class="md-nav__icon md-icon"></span>
          Code security
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../code_security/bandit/" class="md-nav__link">
        Bandit
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Lectures
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Lectures" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Lectures
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../lectures/gradient_centralization/" class="md-nav__link">
        Gradient Centralization
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table des matières">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#import-des-librairies-creation-du-dataset" class="md-nav__link">
    Import des librairies, création du dataset
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pruningelagage" class="md-nav__link">
    Pruning/Elagage
  </a>
  
    <nav class="md-nav" aria-label="Pruning/Elagage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#elagage-constant" class="md-nav__link">
    Elagage constant
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#decroissance-polynomiale" class="md-nav__link">
    Décroissance polynomiale
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mise-en-place" class="md-nav__link">
    Mise en place
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="tp-module-9-optimisation-des-modeles-elagage">TP Module 9 : Optimisation des modèles, élagage</h1>
<h2 id="import-des-librairies-creation-du-dataset">Import des librairies, création du dataset</h2>
<p>Importons d'abord les librairies qui nous serons nécessaires.</p>
<div class="admonition tf">
<p class="admonition-title">TensorFlow</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">from</span> <span class="nn">tensorflow</span> <span class="kn">import</span> <span class="n">keras</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">from</span> <span class="nn">tensorflow.keras.models</span> <span class="kn">import</span> <span class="n">load_model</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="kn">from</span> <span class="nn">loguru</span> <span class="kn">import</span> <span class="n">logger</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="kn">import</span> <span class="nn">random</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="kn">import</span> <span class="nn">datetime</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="c1"># freeze de l&#39;aléatoire, pour avoir des expériences reproductibles.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="n">RANDOM_SEED</span> <span class="o">=</span> <span class="mi">42</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PYTHONHASHSEED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TF_DETERMINISTIC_OPS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1&#39;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<p>Comme nous aurons besoin de créer de nouveaux des datasets pour l'entrainement, décrivons une classe qui nous permettra de le faire.</p>
<div class="admonition tf">
<p class="admonition-title">Tensorize</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">  1</a></span>
<span class="normal"><a href="#__codelineno-1-2">  2</a></span>
<span class="normal"><a href="#__codelineno-1-3">  3</a></span>
<span class="normal"><a href="#__codelineno-1-4">  4</a></span>
<span class="normal"><a href="#__codelineno-1-5">  5</a></span>
<span class="normal"><a href="#__codelineno-1-6">  6</a></span>
<span class="normal"><a href="#__codelineno-1-7">  7</a></span>
<span class="normal"><a href="#__codelineno-1-8">  8</a></span>
<span class="normal"><a href="#__codelineno-1-9">  9</a></span>
<span class="normal"><a href="#__codelineno-1-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-1-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-1-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-1-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-1-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-1-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-1-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-1-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-1-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-1-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-1-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-1-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-1-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-1-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-1-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-1-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-1-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-1-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-1-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-1-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-1-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-1-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-1-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-1-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-1-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-1-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-1-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-1-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-1-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-1-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-1-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-1-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-1-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-1-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-1-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-1-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-1-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-1-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-1-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-1-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-1-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-1-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-1-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-1-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-1-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-1-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-1-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-1-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-1-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-1-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-1-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-1-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-1-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-1-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-1-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-1-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-1-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-1-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-1-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-1-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-1-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-1-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-1-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-1-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-1-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-1-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-1-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-1-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-1-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-1-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-1-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-1-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-1-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-1-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-1-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-1-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-1-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-1-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-1-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-1-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-1-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-1-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-1-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-1-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-1-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-1-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-1-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-1-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-1-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-1-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-1-100">100</a></span>
<span class="normal"><a href="#__codelineno-1-101">101</a></span>
<span class="normal"><a href="#__codelineno-1-102">102</a></span>
<span class="normal"><a href="#__codelineno-1-103">103</a></span>
<span class="normal"><a href="#__codelineno-1-104">104</a></span>
<span class="normal"><a href="#__codelineno-1-105">105</a></span>
<span class="normal"><a href="#__codelineno-1-106">106</a></span>
<span class="normal"><a href="#__codelineno-1-107">107</a></span>
<span class="normal"><a href="#__codelineno-1-108">108</a></span>
<span class="normal"><a href="#__codelineno-1-109">109</a></span>
<span class="normal"><a href="#__codelineno-1-110">110</a></span>
<span class="normal"><a href="#__codelineno-1-111">111</a></span>
<span class="normal"><a href="#__codelineno-1-112">112</a></span>
<span class="normal"><a href="#__codelineno-1-113">113</a></span>
<span class="normal"><a href="#__codelineno-1-114">114</a></span>
<span class="normal"><a href="#__codelineno-1-115">115</a></span>
<span class="normal"><a href="#__codelineno-1-116">116</a></span>
<span class="normal"><a href="#__codelineno-1-117">117</a></span>
<span class="normal"><a href="#__codelineno-1-118">118</a></span>
<span class="normal"><a href="#__codelineno-1-119">119</a></span>
<span class="normal"><a href="#__codelineno-1-120">120</a></span>
<span class="normal"><a href="#__codelineno-1-121">121</a></span>
<span class="normal"><a href="#__codelineno-1-122">122</a></span>
<span class="normal"><a href="#__codelineno-1-123">123</a></span>
<span class="normal"><a href="#__codelineno-1-124">124</a></span>
<span class="normal"><a href="#__codelineno-1-125">125</a></span>
<span class="normal"><a href="#__codelineno-1-126">126</a></span>
<span class="normal"><a href="#__codelineno-1-127">127</a></span>
<span class="normal"><a href="#__codelineno-1-128">128</a></span>
<span class="normal"><a href="#__codelineno-1-129">129</a></span>
<span class="normal"><a href="#__codelineno-1-130">130</a></span>
<span class="normal"><a href="#__codelineno-1-131">131</a></span>
<span class="normal"><a href="#__codelineno-1-132">132</a></span>
<span class="normal"><a href="#__codelineno-1-133">133</a></span>
<span class="normal"><a href="#__codelineno-1-134">134</a></span>
<span class="normal"><a href="#__codelineno-1-135">135</a></span>
<span class="normal"><a href="#__codelineno-1-136">136</a></span>
<span class="normal"><a href="#__codelineno-1-137">137</a></span>
<span class="normal"><a href="#__codelineno-1-138">138</a></span>
<span class="normal"><a href="#__codelineno-1-139">139</a></span>
<span class="normal"><a href="#__codelineno-1-140">140</a></span>
<span class="normal"><a href="#__codelineno-1-141">141</a></span>
<span class="normal"><a href="#__codelineno-1-142">142</a></span>
<span class="normal"><a href="#__codelineno-1-143">143</a></span>
<span class="normal"><a href="#__codelineno-1-144">144</a></span>
<span class="normal"><a href="#__codelineno-1-145">145</a></span>
<span class="normal"><a href="#__codelineno-1-146">146</a></span>
<span class="normal"><a href="#__codelineno-1-147">147</a></span>
<span class="normal"><a href="#__codelineno-1-148">148</a></span>
<span class="normal"><a href="#__codelineno-1-149">149</a></span>
<span class="normal"><a href="#__codelineno-1-150">150</a></span>
<span class="normal"><a href="#__codelineno-1-151">151</a></span>
<span class="normal"><a href="#__codelineno-1-152">152</a></span>
<span class="normal"><a href="#__codelineno-1-153">153</a></span>
<span class="normal"><a href="#__codelineno-1-154">154</a></span>
<span class="normal"><a href="#__codelineno-1-155">155</a></span>
<span class="normal"><a href="#__codelineno-1-156">156</a></span>
<span class="normal"><a href="#__codelineno-1-157">157</a></span>
<span class="normal"><a href="#__codelineno-1-158">158</a></span>
<span class="normal"><a href="#__codelineno-1-159">159</a></span>
<span class="normal"><a href="#__codelineno-1-160">160</a></span>
<span class="normal"><a href="#__codelineno-1-161">161</a></span>
<span class="normal"><a href="#__codelineno-1-162">162</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">class</span> <span class="nc">Tensorize</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class used to create tensor datasets for TensorFlow.</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="sd">    Args:</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="sd">        object (object): The base class of the class hierarchy, used only to enforce</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="sd">            WPS306. See https://wemake-python-stylegui.de/en/latest/pages/usage/</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="sd">            violations/consistency.html#consistency.</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">n_classes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">img_shape</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">random_seed</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialization of the class Featurize.</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="sd">        Initialize the class the number of classes in the datasets, the shape of the</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="sd">        images and the random seed.</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="sd">        Args:</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="sd">            n_classes (int): Number of classes in the dataset.</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="sd">            img_shape (Tuple[int, int, int]): Dimension of the image, format is (H,W,C).</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="sd">            random_seed (int): Fixed random seed for reproducibility.</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span> <span class="o">=</span> <span class="n">n_classes</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">img_shape</span> <span class="o">=</span> <span class="n">img_shape</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span> <span class="o">=</span> <span class="n">random_seed</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">AUTOTUNE</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">experimental</span><span class="o">.</span><span class="n">AUTOTUNE</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a>    <span class="k">def</span> <span class="nf">load_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_frame</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the images as a list.</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="sd">        Take the dataframe containing the observations and the labels and the return the</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="sd">        column containing the observations as a list.</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="sd">        Args:</span>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="sd">            data_frame (pd.DataFrame): Dataframe containing the dataset.</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="sd">            column_name (str): The name of the column containing the observations.</span>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="sd">        Returns:</span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="sd">            The list of observations deduced from the dataframe.</span>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a>        <span class="k">return</span> <span class="n">data_frame</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a>
<a id="__codelineno-1-43" name="__codelineno-1-43"></a>    <span class="k">def</span> <span class="nf">load_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_frame</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load the labels as a list and encode them.</span>
<a id="__codelineno-1-45" name="__codelineno-1-45"></a>
<a id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="sd">        Take the dataframe containing the observations and the labels and the return the</span>
<a id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="sd">        column containing the labels as an encoded list.</span>
<a id="__codelineno-1-48" name="__codelineno-1-48"></a>
<a id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="sd">        The encoding is done by taking the set of labels, alphabetically sorted, and</span>
<a id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="sd">        then transforming them as integers starting from 0.</span>
<a id="__codelineno-1-51" name="__codelineno-1-51"></a>
<a id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="sd">        `from sklearn.preprocessing import LabelEncoder` works well to encode labels,</span>
<a id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="sd">        but if the dataset is huge, the time it takes to encode all the labels is</span>
<a id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="sd">        growing fast. We use anumpy and vectorization to speed up the time.</span>
<a id="__codelineno-1-55" name="__codelineno-1-55"></a>
<a id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="sd">        See the StackOverflow question :</span>
<a id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="sd">        [Question](https://stackoverflow.com/questions/45321999/</span>
<a id="__codelineno-1-58" name="__codelineno-1-58"></a><span class="sd">        how-can-i-optimize-label-encoding-for-large-data-sets-sci-kit-learn)</span>
<a id="__codelineno-1-59" name="__codelineno-1-59"></a>
<a id="__codelineno-1-60" name="__codelineno-1-60"></a><span class="sd">        Args:</span>
<a id="__codelineno-1-61" name="__codelineno-1-61"></a><span class="sd">            data_frame (pd.DataFrame): Dataframe containing the dataset.</span>
<a id="__codelineno-1-62" name="__codelineno-1-62"></a><span class="sd">            column_name (str): The name of the column containing the labels.</span>
<a id="__codelineno-1-63" name="__codelineno-1-63"></a>
<a id="__codelineno-1-64" name="__codelineno-1-64"></a><span class="sd">        Returns:</span>
<a id="__codelineno-1-65" name="__codelineno-1-65"></a><span class="sd">            The list of encoded labels deduced from the dataframe.</span>
<a id="__codelineno-1-66" name="__codelineno-1-66"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-67" name="__codelineno-1-67"></a>        <span class="n">label_list</span> <span class="o">=</span> <span class="n">data_frame</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-1-68" name="__codelineno-1-68"></a>        <span class="n">classes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">label_list</span><span class="p">))</span>
<a id="__codelineno-1-69" name="__codelineno-1-69"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found following labels </span><span class="si">{</span><span class="n">classes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-1-70" name="__codelineno-1-70"></a>
<a id="__codelineno-1-71" name="__codelineno-1-71"></a>        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">label_list</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-1-72" name="__codelineno-1-72"></a>        <span class="n">dic</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">label_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>
<a id="__codelineno-1-73" name="__codelineno-1-73"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dictionnary creation </span><span class="si">{</span><span class="n">dic</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-1-74" name="__codelineno-1-74"></a>        <span class="n">vectorized_get</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">dic</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
<a id="__codelineno-1-75" name="__codelineno-1-75"></a>
<a id="__codelineno-1-76" name="__codelineno-1-76"></a>        <span class="k">return</span> <span class="n">vectorized_get</span><span class="p">(</span><span class="n">label_list</span><span class="p">)</span>
<a id="__codelineno-1-77" name="__codelineno-1-77"></a>
<a id="__codelineno-1-78" name="__codelineno-1-78"></a>    <span class="k">def</span> <span class="nf">parse_image_and_label</span><span class="p">(</span>
<a id="__codelineno-1-79" name="__codelineno-1-79"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-1-80" name="__codelineno-1-80"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-1-81" name="__codelineno-1-81"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Transform image and label.</span>
<a id="__codelineno-1-82" name="__codelineno-1-82"></a>
<a id="__codelineno-1-83" name="__codelineno-1-83"></a><span class="sd">        Parse image to go from path to a resized np.ndarray, and parse the labels to</span>
<a id="__codelineno-1-84" name="__codelineno-1-84"></a><span class="sd">        one-hot encode them.</span>
<a id="__codelineno-1-85" name="__codelineno-1-85"></a>
<a id="__codelineno-1-86" name="__codelineno-1-86"></a><span class="sd">        Args:</span>
<a id="__codelineno-1-87" name="__codelineno-1-87"></a><span class="sd">            filename (str): The path of the image to parse.</span>
<a id="__codelineno-1-88" name="__codelineno-1-88"></a><span class="sd">            label (int): The label of the image, as an int, to one-hot encode.</span>
<a id="__codelineno-1-89" name="__codelineno-1-89"></a>
<a id="__codelineno-1-90" name="__codelineno-1-90"></a><span class="sd">        Returns:</span>
<a id="__codelineno-1-91" name="__codelineno-1-91"></a><span class="sd">            A np.ndarray corresponding to the image and the corresponding one-hot label.</span>
<a id="__codelineno-1-92" name="__codelineno-1-92"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-93" name="__codelineno-1-93"></a>        <span class="n">resized_dims</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">img_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
<a id="__codelineno-1-94" name="__codelineno-1-94"></a>        <span class="c1"># convert the label to one-hot encoding</span>
<a id="__codelineno-1-95" name="__codelineno-1-95"></a>        <span class="n">label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">one_hot</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_classes</span><span class="p">)</span>
<a id="__codelineno-1-96" name="__codelineno-1-96"></a>        <span class="c1"># decode image</span>
<a id="__codelineno-1-97" name="__codelineno-1-97"></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<a id="__codelineno-1-98" name="__codelineno-1-98"></a>        <span class="c1"># Don&#39;t use tf.image.decode_image,</span>
<a id="__codelineno-1-99" name="__codelineno-1-99"></a>        <span class="c1"># or the output shape will be undefined</span>
<a id="__codelineno-1-100" name="__codelineno-1-100"></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">decode_jpeg</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-1-101" name="__codelineno-1-101"></a>        <span class="c1"># This will convert to float values in [0, 1]</span>
<a id="__codelineno-1-102" name="__codelineno-1-102"></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">convert_image_dtype</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<a id="__codelineno-1-103" name="__codelineno-1-103"></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">resized_dims</span><span class="p">)</span>
<a id="__codelineno-1-104" name="__codelineno-1-104"></a>
<a id="__codelineno-1-105" name="__codelineno-1-105"></a>        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
<a id="__codelineno-1-106" name="__codelineno-1-106"></a>
<a id="__codelineno-1-107" name="__codelineno-1-107"></a>    <span class="k">def</span> <span class="nf">train_preprocess</span><span class="p">(</span>
<a id="__codelineno-1-108" name="__codelineno-1-108"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<a id="__codelineno-1-109" name="__codelineno-1-109"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<a id="__codelineno-1-110" name="__codelineno-1-110"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Augmentation preprocess, if needed.</span>
<a id="__codelineno-1-111" name="__codelineno-1-111"></a>
<a id="__codelineno-1-112" name="__codelineno-1-112"></a><span class="sd">        Args:</span>
<a id="__codelineno-1-113" name="__codelineno-1-113"></a><span class="sd">            image (np.ndarray): The image to augment.</span>
<a id="__codelineno-1-114" name="__codelineno-1-114"></a><span class="sd">            label (List[int]): The corresponding label.</span>
<a id="__codelineno-1-115" name="__codelineno-1-115"></a>
<a id="__codelineno-1-116" name="__codelineno-1-116"></a><span class="sd">        Returns:</span>
<a id="__codelineno-1-117" name="__codelineno-1-117"></a><span class="sd">            The augmented pair.</span>
<a id="__codelineno-1-118" name="__codelineno-1-118"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-119" name="__codelineno-1-119"></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">random_flip_left_right</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-1-120" name="__codelineno-1-120"></a>        <span class="n">image</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">random_flip_up_down</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<a id="__codelineno-1-121" name="__codelineno-1-121"></a>
<a id="__codelineno-1-122" name="__codelineno-1-122"></a>        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">label</span>
<a id="__codelineno-1-123" name="__codelineno-1-123"></a>
<a id="__codelineno-1-124" name="__codelineno-1-124"></a>    <span class="k">def</span> <span class="nf">create_dataset</span><span class="p">(</span>
<a id="__codelineno-1-125" name="__codelineno-1-125"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-1-126" name="__codelineno-1-126"></a>        <span class="n">data_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-1-127" name="__codelineno-1-127"></a>        <span class="n">batch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-1-128" name="__codelineno-1-128"></a>        <span class="n">repet</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-1-129" name="__codelineno-1-129"></a>        <span class="n">prefetch</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-1-130" name="__codelineno-1-130"></a>        <span class="n">augment</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<a id="__codelineno-1-131" name="__codelineno-1-131"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<a id="__codelineno-1-132" name="__codelineno-1-132"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Creation of a tensor dataset for TensorFlow.</span>
<a id="__codelineno-1-133" name="__codelineno-1-133"></a>
<a id="__codelineno-1-134" name="__codelineno-1-134"></a><span class="sd">        Args:</span>
<a id="__codelineno-1-135" name="__codelineno-1-135"></a><span class="sd">            data_path (str): Path where the csv file containing the dataframe is</span>
<a id="__codelineno-1-136" name="__codelineno-1-136"></a><span class="sd">                located.</span>
<a id="__codelineno-1-137" name="__codelineno-1-137"></a><span class="sd">            batch (int): Batch size, usually 32.</span>
<a id="__codelineno-1-138" name="__codelineno-1-138"></a><span class="sd">            repet (int): How many times the dataset has to be repeated.</span>
<a id="__codelineno-1-139" name="__codelineno-1-139"></a><span class="sd">            prefetch (int): How many batch the CPU has to prepare in advance for the</span>
<a id="__codelineno-1-140" name="__codelineno-1-140"></a><span class="sd">                GPU.</span>
<a id="__codelineno-1-141" name="__codelineno-1-141"></a><span class="sd">            augment (bool): Does the dataset has to be augmented or no.</span>
<a id="__codelineno-1-142" name="__codelineno-1-142"></a>
<a id="__codelineno-1-143" name="__codelineno-1-143"></a><span class="sd">        Returns:</span>
<a id="__codelineno-1-144" name="__codelineno-1-144"></a><span class="sd">            A batch of observations and labels.</span>
<a id="__codelineno-1-145" name="__codelineno-1-145"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-1-146" name="__codelineno-1-146"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">data_path</span><span class="p">)</span>
<a id="__codelineno-1-147" name="__codelineno-1-147"></a>        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_images</span><span class="p">(</span><span class="n">data_frame</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span>
<a id="__codelineno-1-148" name="__codelineno-1-148"></a>        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_labels</span><span class="p">(</span><span class="n">data_frame</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">column_name</span><span class="o">=</span><span class="s2">&quot;label&quot;</span><span class="p">)</span>
<a id="__codelineno-1-149" name="__codelineno-1-149"></a>
<a id="__codelineno-1-150" name="__codelineno-1-150"></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">from_tensor_slices</span><span class="p">((</span><span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>
<a id="__codelineno-1-151" name="__codelineno-1-151"></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">),</span> <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
<a id="__codelineno-1-152" name="__codelineno-1-152"></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repet</span><span class="p">)</span>
<a id="__codelineno-1-153" name="__codelineno-1-153"></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
<a id="__codelineno-1-154" name="__codelineno-1-154"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">parse_image_and_label</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTOTUNE</span>
<a id="__codelineno-1-155" name="__codelineno-1-155"></a>        <span class="p">)</span>
<a id="__codelineno-1-156" name="__codelineno-1-156"></a>        <span class="k">if</span> <span class="n">augment</span><span class="p">:</span>
<a id="__codelineno-1-157" name="__codelineno-1-157"></a>            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
<a id="__codelineno-1-158" name="__codelineno-1-158"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">train_preprocess</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">AUTOTUNE</span>
<a id="__codelineno-1-159" name="__codelineno-1-159"></a>            <span class="p">)</span>
<a id="__codelineno-1-160" name="__codelineno-1-160"></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-1-161" name="__codelineno-1-161"></a>        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
<a id="__codelineno-1-162" name="__codelineno-1-162"></a>        <span class="k">return</span> <span class="n">dataset</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span><span class="n">prefetch</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<p>et créons nos 3 datasets classiques.</p>
<div class="admonition warning">
<p class="admonition-title">Attention</p>
<p>Bien vérifier sur où pointent les adresses dans les csv.</p>
</div>
<div class="admonition tf">
<p class="admonition-title">ds, ds_val, ds_train</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span>
<span class="normal"><a href="#__codelineno-2-26">26</a></span>
<span class="normal"><a href="#__codelineno-2-27">27</a></span>
<span class="normal"><a href="#__codelineno-2-28">28</a></span>
<span class="normal"><a href="#__codelineno-2-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">ts</span> <span class="o">=</span> <span class="n">Tensorize</span><span class="p">(</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>            <span class="n">n_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>            <span class="n">img_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">224</span><span class="p">,</span><span class="mi">224</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>            <span class="n">random_seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>        <span class="p">)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="n">ds</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>    <span class="s2">&quot;prepared_dataset/train.csv&quot;</span><span class="p">,</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>    <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>    <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>    <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>    <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="n">ds_val</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>    <span class="s2">&quot;prepared_dataset/val.csv&quot;</span><span class="p">,</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>    <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a>    <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a>    <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>    <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="p">)</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="n">ds_test</span> <span class="o">=</span> <span class="n">ts</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a>    <span class="s2">&quot;prepared_dataset/test.csv&quot;</span><span class="p">,</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a>    <span class="mi">32</span><span class="p">,</span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a>    <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a>    <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a>    <span class="kc">True</span><span class="p">,</span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<p>Une fois que l'on est là, on peut charger notre modèle de base, entraîné sans optimisations particulières.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span>
<span class="normal"><a href="#__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">model_vanilla</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;../facemask_detector.h5&quot;</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="n">model_vanilla</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_test</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<div class="admonition ubuntu">
<p class="admonition-title">Remarque</p>
<p>Si l'on voit voir la taille du modèle, on peut utiliser la commande shell suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1"># Check size</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>du<span class="w"> </span>--all<span class="w"> </span>-h<span class="w"> </span>../facemask_detector.h5
</code></pre></div></td></tr></table></div>
<p>Ne pas oublier le "!" avant si vous le faites dans un notebbok jupyter.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1"># Check size</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>!du<span class="w"> </span>--all<span class="w"> </span>-h<span class="w"> </span>../facemask_detector.h5
</code></pre></div></td></tr></table></div>
</div>
<h2 id="pruningelagage">Pruning/Elagage</h2>
<p>Comme dit précédemment, pour pouvoir appliquer l'élagage pour optimiser le modèle, on va avoir besoin de la librairie <strong>tensorflow-model-optimization</strong>.</p>
<div class="admonition tf">
<p class="admonition-title">TFMOT</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">q</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="n">optimization</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="kn">import</span> <span class="nn">tensorflow_model_optimization</span> <span class="k">as</span> <span class="nn">tfmot</span>
</code></pre></div></td></tr></table></div>
</div>
<p>Pour chaque couche choisie pour être élaguée, un masque binaire est construit de la même dimension que le tenseur de poids de la couche et il détermine quels poids participent à l'étape de feedforward.</p>
<p>Les poids sont ordonnés suivant leur valeurs absolues et l'on masque les poids de plus petite valeur absolue jusqu'à ce qu'un certain seuil <span class="arithmatex">\(s \in ]0,1[\)</span> de valeurs masquées soit atteint.</p>
<p>Lors de l'étape de rétropropagation, le gradient passant par le masque binaire seuls les poids non masquées sont mis à jour.</p>
<p>Au fur et à mesure que le taux d'apprentissage baisse, il a été observé que les poids élagués alors que ce dernier est très petit sont difficilement compensés par les autres. Il est donc important de choisir le bon LRD et de ne pas élaguer tout le long de l'entraînement.</p>
<p>Dans TFMOT, on a en particuliers deux méthodes pour élaguer les modèles, l'élagage constant, et l'élagage avec décroissance polynomiale.</p>
<h3 id="elagage-constant">Elagage constant</h3>
<div class="admonition tf">
<p class="admonition-title">ConstantSparsity</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a>    <span class="n">target_sparsity</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># A scalar float representing the target sparsity value.</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="n">begin_step</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Step at which to begin pruning.</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>    <span class="n">end_step</span> <span class="o">=</span>  <span class="o">-</span><span class="mi">1</span> <span class="c1"># Step at which to end pruning. -1 by default. -1 implies continuing to prune till the end of training.</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>    <span class="n">frequency</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Only apply pruning every frequency steps.</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>    <span class="n">epochs</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># Number of epochs we&#39;ll fine tune with pruning</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>    <span class="c1"># Define pruning schedule</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>    <span class="n">pruning_params</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>        <span class="s1">&#39;pruning_schedule&#39;</span><span class="p">:</span> <span class="n">tfmot</span><span class="o">.</span><span class="n">sparsity</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">ConstantSparsity</span><span class="p">(</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>            <span class="n">target_sparsity</span><span class="o">=</span><span class="n">target_sparsity</span><span class="p">,</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>            <span class="n">begin_step</span><span class="o">=</span><span class="n">begin_step</span><span class="p">,</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>            <span class="n">end_step</span><span class="o">=</span><span class="n">end_step</span><span class="p">,</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>            <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>        <span class="p">)</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<p>Détaillons.</p>
<ul>
<li>
<p>Elaguer signifie que nous souhaitons avoir uniquement un certain nombre/pourcentage de poids non nuls, ce pourcentage est défini par notre variable <code>target_sparsity</code>, ici fixée à <span class="arithmatex">\(0.5\)</span>. A la fin de l'entraînement, nous aurons donc <span class="arithmatex">\(50\%\)</span> des poids des couches élaguées (couches denses, convolutives) qui seront nuls.</p>
</li>
<li>
<p>De par l'observation donnée au dessus, nous n'allons pas élaguer sur toute la durée de l'entraînement, mais seulement sur les <code>epochs = 4</code> premières époques de l'entraînement. Notre dataset étant relativement petit, nous allons élaguer à chaque étape (<code>frequency</code>) des ces époques, de la première étape (<code>begin_step</code>), à la dernière de l'époque <span class="arithmatex">\(4\)</span> (<code>end_step</code>).</p>
</li>
<li>
<p>Chacune de ces variables sert de paramètre à la fonction <code>tfmot.sparsity.keras.ConstantSparsity</code>, qui définit comment va se faire l'élagage. Ici on a choisi un élagage constant (<code>ConstantSparsity</code>) sur les étapes et époques, ce qui signifie qu'à chaque étape on choisira la moitié haute des poids : <strong>ceux de plus haute magnitude</strong>, et que les autres seront mis à zéro.</p>
</li>
</ul>
<h3 id="decroissance-polynomiale">Décroissance polynomiale</h3>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<p>We introduce a new automated gradual pruning algorithm in which the sparsity is increased from an initial sparsity value <span class="arithmatex">\(s_i\)</span> (usually <span class="arithmatex">\(0\)</span>) to a final sparsity value <span class="arithmatex">\(s_f\)</span> over a span of <span class="arithmatex">\(n\)</span> pruning steps, starting at training step <span class="arithmatex">\(t_0\)</span> and with pruning frequency <span class="arithmatex">\(\Delta t\)</span>, <a href="https://arxiv.org/pdf/1710.01878.pdf">Source</a>.</p>
</div>
<div class="arithmatex">\[
s_t  = s_f  + (s_i - s_f) \cdot \left(1-\frac{t - t_0}{n\Delta t} \right) ^{3} \quad t \in \{ t_{0}, t_{0}+\Delta t, \dots, t_{0}+n\Delta t\}
\]</div>
<p><a href="https://github.com/tensorflow/model-optimization/blob/v0.5.0/tensorflow_model_optimization/python/core/sparsity/keras/pruning_schedule.py#L183-L262">Le code source de la fonction sur le github de TFMOT définit la fonction d'élagague de la façon suivante</a> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span>
<span class="normal"><a href="#__codelineno-8-4">4</a></span>
<span class="normal"><a href="#__codelineno-8-5">5</a></span>
<span class="normal"><a href="#__codelineno-8-6">6</a></span>
<span class="normal"><a href="#__codelineno-8-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a>Initializes a Pruning schedule with a PolynomialDecay function.
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>Pruning rate grows rapidly in the beginning from initial_sparsity,
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>but then plateaus slowly to the target sparsity. The function applied is
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>    current_sparsity = final_sparsity + (initial_sparsity - final_sparsity) *
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>    (1 - (step - begin_step)/(end_step - begin_step)) ^ exponent
</code></pre></div></td></tr></table></div>
<div class="admonition info">
<p class="admonition-title">Note</p>
<p>Pour avoir le nombre total d'étapes durant l'entraînement, on peut utiliser la fonction suivante :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="n">end_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">num_images</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="n">epochs</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="admonition tf">
<p class="admonition-title">PolynomialDecay</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span>
<span class="normal"><a href="#__codelineno-10-15">15</a></span>
<span class="normal"><a href="#__codelineno-10-16">16</a></span>
<span class="normal"><a href="#__codelineno-10-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">initial_sparsity</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># Sparsity (%) at which pruning begins.</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="n">final_sparsity</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="c1"># Sparsity (%) at which pruning ends.</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="n">begin_step</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Step at which to begin pruning.</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="n">end_step</span> <span class="o">=</span>  <span class="mi">10</span> <span class="c1"># Step at which to end pruning.</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="n">frequency</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Only apply pruning every frequency steps.</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="c1"># Define pruning schedule</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="n">pruning_params</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>    <span class="s1">&#39;pruning_schedule&#39;</span><span class="p">:</span> <span class="n">tfmot</span><span class="o">.</span><span class="n">sparsity</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">PolynomialDecay</span><span class="p">(</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>        <span class="n">initial_sparsity</span> <span class="o">=</span> <span class="n">initial_sparsity</span><span class="p">,</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>        <span class="n">final_sparsity</span> <span class="o">=</span> <span class="n">final_sparsity</span><span class="p">,</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a>        <span class="n">begin_step</span> <span class="o">=</span> <span class="n">begin_step</span><span class="p">,</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a>        <span class="n">end_step</span> <span class="o">=</span> <span class="n">end_step</span><span class="p">,</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a>        <span class="n">power</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>        <span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span><span class="p">,</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a>    <span class="p">)</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<p>Tout concorde avec la définition de l'article, sauf <span class="arithmatex">\(n\Delta t\)</span> et <code>end_step - begin_step</code>. On a</p>
<ul>
<li>initial_sparsity = <span class="arithmatex">\(s_i\)</span>,</li>
<li>final_sparsity = <span class="arithmatex">\(s_f\)</span>,</li>
<li>begin_step = <span class="arithmatex">\(t_0\)</span>,</li>
<li>power = <span class="arithmatex">\(3\)</span>,</li>
</ul>
<p>Reste à déterminer</p>
<ul>
<li>end_step = <span class="arithmatex">\(t_f\)</span>,</li>
<li>frequency = <span class="arithmatex">\(\Delta t\)</span>,</li>
</ul>
<p>Regardons le code source, les lignes intéressantes sont les lignes <span class="arithmatex">\(247-248\)</span>, où l'on a le code :</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">_should_prune_in_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">begin_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_step</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">),</span>
</code></pre></div></td></tr></table></div>
La fonction <a href="https://github.com/tensorflow/model-optimization/blob/v0.5.0/tensorflow_model_optimization/python/core/sparsity/keras/pruning_schedule.py#L183-L262">PolynomialDecay</a> demande en fait à une autre fonction de contrôle si elle doit pratiquer un élagage ou non. Cette fonction, <code>self._should_prune_in_step</code>, est définie <a href="https://github.com/tensorflow/model-optimization/blob/973f5b394a99b0a775e3b9f7178c865509a7d559/tensorflow_model_optimization/python/core/sparsity/keras/pruning_schedule.py#L41">ici</a>.</p>
<p>Les lignes intéressantes sont les lignes <span class="arithmatex">\(62-65\)</span> :</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">is_pruning_turn</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>    <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">floormod</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">begin_step</span><span class="p">),</span> <span class="n">frequency</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">is_in_pruning_range</span><span class="p">,</span> <span class="n">is_pruning_turn</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
Les deux premières lignes demandent si <span class="arithmatex">\(t-t_{0} \equiv 0 \, \mathrm{mod} \Delta t\)</span>, en d'autres termes si <span class="arithmatex">\(t-t_{0}\)</span> est un multiple du paramètre <span class="arithmatex">\(\Delta t\)</span>, <code>frequency</code>, et retroune un booléen. De plus la fonction vérifie que l'on est bien dans l'intervalle <span class="arithmatex">\([\)</span><code>begin_step</code>, <code>end_step</code><span class="arithmatex">\(]\)</span> pour élaguer.</p>
<p>Ce qui veut dire que <strong>durant la période d'entraînement <span class="arithmatex">\([\)</span><code>begin_step</code>, <code>end_step</code><span class="arithmatex">\(]\)</span>, on ne peut élaguer que si <span class="arithmatex">\(t-t_{0}\)</span> est un multiple de la fréquence</strong>, ce qui concorde avec la formule de l'article.</p>
<div class="admonition info">
<p class="admonition-title">Comportement de l'élagage</p>
<p><img alt="pruning" src="../images/pruning.svg" /></p>
<p>Le comportement de l'élagage polynomial au cours de l'entraînement. <a href="https://arxiv.org/pdf/1710.01878.pdf">Source</a>.</p>
</div>
<h3 id="mise-en-place">Mise en place</h3>
<div class="admonition tf">
<p class="admonition-title">Compilation du modèle</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="n">model_for_pruning</span> <span class="o">=</span> <span class="n">tfmot</span><span class="o">.</span><span class="n">sparsity</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">prune_low_magnitude</span><span class="p">(</span><span class="n">model_vanilla</span><span class="p">,</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>                                                         <span class="o">**</span><span class="n">pruning_params</span><span class="p">)</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="c1"># prune_low_magnitude requires a recompile.</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="n">model_for_pruning</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;sgd&#39;</span><span class="p">,</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>                        <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>                        <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="c1"># Train the model.</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="n">logdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="n">callbacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tfmot</span><span class="o">.</span><span class="n">sparsity</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">UpdatePruningStep</span><span class="p">(),</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a>            <span class="n">tfmot</span><span class="o">.</span><span class="n">sparsity</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">PruningSummaries</span><span class="p">(</span><span class="n">log_dir</span><span class="o">=</span><span class="n">logdir</span><span class="p">)]</span>
</code></pre></div></td></tr></table></div>
</div>
<p>Une fois que la méthode d'élagage a été correctement définie, le modèle est alors envoyé dans la fonction <code>tfmot.sparsity.keras.prune_low_magnitude(original_model, **pruning_params)</code> afin de créer les masques binaires qui serviront à l'élagage.</p>
<p>Des couches ayant été rajoutées (les masques binaires), il est nécéssaire de recompiler le modèle</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1"># prune_low_magnitude requires a recompile.</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="n">model_for_pruning</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;sgd&#39;</span><span class="p">,</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a>                          <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>                          <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
<p>On peut alors maintenant lancer un nouvel entraînement pour élaguer notre modèle.</p>
<div class="admonition tf">
<p class="admonition-title">Entraînement</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span>
<span class="normal"><a href="#__codelineno-15-5">5</a></span>
<span class="normal"><a href="#__codelineno-15-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="n">history</span> <span class="o">=</span> <span class="n">model_for_pruning</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>                                <span class="n">validation_data</span><span class="o">=</span><span class="n">ds_val</span><span class="p">,</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a>                                <span class="n">epochs</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>                                <span class="n">callbacks</span><span class="o">=</span><span class="n">callbacks</span><span class="p">)</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total training time: &quot;</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<p>Une fois l'entraînement terminé, on peut vérifier que toutes les couches pouvant être élaguées ont bien <span class="arithmatex">\(50\%\)</span> des leur poids qui sont nuls avec l'aide de la fonction suivante.</p>
<div class="admonition tf">
<p class="admonition-title">Sanity Check</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a>    <span class="c1">#Sanity check to see if the sparsity threshold is reached</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="kn">from</span> <span class="nn">tensorflow_model_optimization.python.core.sparsity.keras</span> <span class="kn">import</span> <span class="n">pruning_wrapper</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="k">def</span> <span class="nf">get_sparsity</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a>    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="k">def</span> <span class="nf">test_sparsity</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">target_sparsity</span><span class="p">):</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a>    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">pruning_wrapper</span><span class="o">.</span><span class="n">PruneLowMagnitude</span><span class="p">):</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a>            <span class="k">for</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">layer</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">get_prunable_weights</span><span class="p">():</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a>                <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a>                    <span class="n">target_sparsity</span><span class="p">,</span> <span class="n">get_sparsity</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">weight</span><span class="p">)),</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a>                    <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="n">test_sparsity</span><span class="p">(</span><span class="n">model_for_pruning</span><span class="p">,</span> <span class="n">target_sparsity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="admonition attention">
<p class="admonition-title">Attention</p>
<p>On a rajouté des couches (les masques binaires) lors du lancement de l'entraînement, il est nécéssaire des les retirer pour pouvoir profiter du modèle par la suite.</p>
</div>
<div class="admonition tf">
<p class="admonition-title">Stripping</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="c1"># Once a model has been pruned to required sparsity, this method can be used to restore the original model with the sparse weights.</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="n">pruned_model_for_export</span> <span class="o">=</span> <span class="n">tfmot</span><span class="o">.</span><span class="n">sparsity</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">strip_pruning</span><span class="p">(</span><span class="n">model_for_pruning</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<p>Une fois que le modèle a été élagué avec les critères voulus, il est nécéssaire de le recompiler pour pouvoir l'utiliser.</p>
<div class="admonition tf">
<p class="admonition-title">Dernière compilation</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span>
<span class="normal"><a href="#__codelineno-19-3">3</a></span>
<span class="normal"><a href="#__codelineno-19-4">4</a></span>
<span class="normal"><a href="#__codelineno-19-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="n">pruned_model_for_export</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a>                      <span class="n">loss</span><span class="o">=</span><span class="s1">&#39;categorical_crossentropy&#39;</span><span class="p">,</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a>                      <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="n">pruned_model_for_export</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">ds_test</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span>
<span class="normal"><a href="#__codelineno-20-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="n">pruned_model_for_export</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;pruned_model.h5&#39;</span><span class="p">)</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="n">model_pruned</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;pruned_model.h5&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>On peut alors voir que le modèle a bien <span class="arithmatex">\(50\%\)</span> de ses poids qui sont nuls, sur les couches qui sont les plus impactantes : les noyaux de convolution et les couches denses.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span>
<span class="normal"><a href="#__codelineno-21-3">3</a></span>
<span class="normal"><a href="#__codelineno-21-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">model_pruned</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()):</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>    <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_pruned</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> -- Total: </span><span class="si">{</span><span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">, Zeros: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a>        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Pour voir la taille finale du modèle optimisé, on peut alors utiliser la fonction suivante.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="k">def</span> <span class="nf">get_gzipped_model_size</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a>    <span class="c1"># Returns size of gzipped model, in bytes.</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a>    <span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a>    <span class="kn">import</span> <span class="nn">zipfile</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a>    <span class="n">_</span><span class="p">,</span> <span class="n">zipped_file</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="s1">&#39;.zip&#39;</span><span class="p">)</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a>    <span class="k">with</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">zipped_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="n">zipfile</span><span class="o">.</span><span class="n">ZIP_DEFLATED</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a>    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">zipped_file</span><span class="p">)</span>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a>
<a id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Size of gzipped pruned model trained from scratch: </span><span class="si">{</span><span class="n">get_gzipped_model_size</span><span class="p">(</span><span class="s1">&#39;pruned_model.h5&#39;</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> octets&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>





                
              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Retour en haut de la page
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.tabs", "navigation.top", "navigation.tabs.sticky", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.12658920.min.js", "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.5cf534bf.min.js"></script>
      
        <script src="../../../javascripts/config.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>